

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Line radiative transfer &mdash; radmc3d 2.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Making images and spectra" href="imagesspectra.html" />
    <link rel="prev" title="Dust continuum radiative transfer" href="dustradtrans.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> radmc3d
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstarting with RADMC-3D</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview of the RADMC-3D package</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation of RADMC-3D</a></li>
<li class="toctree-l1"><a class="reference internal" href="basicstructure.html">Basic structure and functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="dustradtrans.html">Dust continuum radiative transfer</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Line radiative transfer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#quick-start-for-adding-line-transfer-to-images-and-spectra">Quick start for adding line transfer to images and spectra</a></li>
<li class="toctree-l2"><a class="reference internal" href="#some-definitions-for-line-transfer">Some definitions for line transfer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#line-transfer-modes-and-how-to-activate-the-line-transfer">Line transfer modes and how to activate the line transfer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#two-different-atomic-molecular-data-file-types">Two different atomic/molecular data file types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-different-line-modes-the-lines-mode-parameter">The different line modes (the <code class="docutils literal notranslate"><span class="pre">lines_mode</span> <span class="pre">parameter</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#the-various-input-files-for-line-transfer">The various input files for line transfer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#input-the-line-transfer-entries-in-the-radmc3d-inp-file">INPUT: The line transfer entries in the radmc3d.inp file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#input-the-line-inp-file">INPUT: The line.inp file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#input-molecular-atomic-data-the-molecule-xxx-inp-file-s">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#input-molecular-atomic-data-the-linelist-xxx-inp-file-s">INPUT: Molecular/atomic data: The linelist_XXX.inp file(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#input-the-number-density-of-each-molecular-species">INPUT: The number density of each molecular species</a></li>
<li class="toctree-l3"><a class="reference internal" href="#input-the-gas-temperature">INPUT: The gas temperature</a></li>
<li class="toctree-l3"><a class="reference internal" href="#input-the-velocity-field">INPUT: The velocity field</a></li>
<li class="toctree-l3"><a class="reference internal" href="#input-the-local-microturbulent-broadening-optional">INPUT: The local microturbulent broadening (optional)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#input-for-lte-line-transfer-the-partition-function-optional">INPUT for LTE line transfer: The partition function (optional)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#input-the-number-density-of-collision-partners-for-non-lte-transfer">INPUT: The number density of collision partners (for non-LTE transfer)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#making-images-and-spectra-with-line-transfer">Making images and spectra with line transfer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#speed-versus-realism-of-rendering-of-line-images-spectra">Speed versus realism of rendering of line images/spectra</a></li>
<li class="toctree-l3"><a class="reference internal" href="#line-emission-scattered-off-dust-grains">Line emission scattered off dust grains</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#non-lte-transfer-the-large-velocity-gradient-lvg-escape-probability-escprob-method">Non-LTE Transfer: The Large Velocity Gradient (LVG) + Escape Probability (EscProb) method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#non-lte-transfer-the-optically-thin-line-assumption-method">Non-LTE Transfer: The optically thin line assumption method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#non-lte-transfer-full-non-local-modes-future">Non-LTE Transfer: Full non-local modes (FUTURE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#non-lte-transfer-inspecting-the-level-populations">Non-LTE Transfer: Inspecting the level populations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#non-lte-transfer-reading-the-level-populations-from-file">Non-LTE Transfer: Reading the level populations from file</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-can-go-wrong-with-line-transfer">What can go wrong with line transfer?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preventing-doppler-jumps-the-doppler-catching-method">Preventing doppler jumps: The ‘doppler catching method’</a></li>
<li class="toctree-l2"><a class="reference internal" href="#background-information-calculation-and-storage-of-level-populations">Background information: Calculation and storage of level populations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#in-case-it-is-necessary-on-the-fly-calculation-of-populations">In case it is necessary: On-the-fly calculation of populations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#for-experts-selecting-a-subset-of-lines-and-levels-manually">For experts: Selecting a subset of lines and levels ‘manually’</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="imagesspectra.html">Making images and spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="gridding.html">More information about the gridding</a></li>
<li class="toctree-l1"><a class="reference internal" href="stars.html">More information about the treatment of stars</a></li>
<li class="toctree-l1"><a class="reference internal" href="internalsetup.html">Modifying RADMC-3D: Internal setup and user-specified radiative processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="pythontools.html">Python analysis tool set</a></li>
<li class="toctree-l1"><a class="reference internal" href="toolsinside.html">Analysis tools inside of radmc3d</a></li>
<li class="toctree-l1"><a class="reference internal" href="vtkoutput.html">Visualization with VTK tools (e.g. Paraview or VisIt)</a></li>
<li class="toctree-l1"><a class="reference internal" href="tipsandtricks.html">Tips, tricks and problem hunting</a></li>
<li class="toctree-l1"><a class="reference internal" href="inputoutputfiles.html">Main input and output files of RADMC-3D</a></li>
<li class="toctree-l1"><a class="reference internal" href="binaryio.html">Binary I/O files</a></li>
<li class="toctree-l1"><a class="reference internal" href="clioptions.html">Command-line options</a></li>
<li class="toctree-l1"><a class="reference internal" href="optionscompat.html">Which options are mutually incompatible?</a></li>
<li class="toctree-l1"><a class="reference internal" href="opacitieswww.html">Acquiring opacities from the WWW</a></li>
<li class="toctree-l1"><a class="reference internal" href="versiontracker.html">Version tracker: Development history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">radmc3d</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Line radiative transfer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/lineradtrans.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="line-radiative-transfer">
<span id="chap-line-transfer"></span><h1>Line radiative transfer<a class="headerlink" href="#line-radiative-transfer" title="Permalink to this headline">¶</a></h1>
<p>RADMC-3D is capable of modeling radiative transfer in molecular and/or
atomic lines. Due to the complexity of line radiative transfer, and the huge
computational and memory requirements of full-scale non-LTE line transfer,
RADMC-3D has various different modes of line transfer. Some modes are very
memory efficient, but slower, while others are faster, but less memory
efficient, yet others are more accurate but much slower and memory
demanding. The default mode (and certainly recommended initially) is LTE
ray-tracing in the slow but memory efficient way: the <em>simple LTE mode</em>
(see Section <a class="reference internal" href="#sec-line-trans-modes"><span class="std std-ref">Line transfer modes and how to activate the line transfer</span></a>). Since this is the default mode,
you do not need to specify anything to have this selected.</p>
<div class="section" id="quick-start-for-adding-line-transfer-to-images-and-spectra">
<h2>Quick start for adding line transfer to images and spectra<a class="headerlink" href="#quick-start-for-adding-line-transfer-to-images-and-spectra" title="Permalink to this headline">¶</a></h2>
<p>Do properly model line transfer requires dedication and experimentation.
This is <em>not</em> a simple task. See Section <a class="reference internal" href="#sec-lines-pitfalls"><span class="std std-ref">What can go wrong with line transfer?</span></a> for an
analysis of several pitfalls one may encounter. However, nothing is better
than experimenting and thus gaining hands-on experience. So the easiest and
quickest way to start is to start with one of the simple line transfer test
models in the <code class="docutils literal notranslate"><span class="pre">examples/</span></code> directory.</p>
<p>So simply visit <code class="docutils literal notranslate"><span class="pre">examples/run_test_lines_1/</span></code>, <code class="docutils literal notranslate"><span class="pre">examples/run_test_lines_2/</span></code>
or <code class="docutils literal notranslate"><span class="pre">examples/run_test_lines_3/</span></code> and follow the directions in the <code class="docutils literal notranslate"><span class="pre">README</span></code> file.
The main features of adding line ray tracing to a model is
to add the following files into any previously constructed model with dust
radiative transfer:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lines.inp</span></code>: A control file for line transfer.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code>: or any other molecular data file
containing properties of the molecule or atom.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numberdens_co.inp</span></code> (or its binary version, see Chapter
<a class="reference internal" href="binaryio.html#chap-binary-io"><span class="std std-ref">Binary I/O files</span></a>) or that of another molecule: The number density of
that molecule in units of <span class="math notranslate nohighlight">\(\mathrm{cm}^{-3}\)</span>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gas_temperature.inp</span></code> (or its binary version, see Chapter
<a class="reference internal" href="binaryio.html#chap-binary-io"><span class="std std-ref">Binary I/O files</span></a>): The gas temperature at each grid cell. You do not
need to specify this file if you add the keyword <code class="docutils literal notranslate"><span class="pre">tgas_eq_tdust</span> <span class="pre">=</span> <span class="pre">1</span></code>
into the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file.</p></li>
</ul>
</div>
<div class="section" id="some-definitions-for-line-transfer">
<span id="sec-line-trans-definitions"></span><h2>Some definitions for line transfer<a class="headerlink" href="#some-definitions-for-line-transfer" title="Permalink to this headline">¶</a></h2>
<p>The formal transfer equation is:</p>
<div class="math notranslate nohighlight">
\[\frac{dI_\nu(\omega)}{ds} = j_\nu(\omega) - \alpha_\nu(\omega)I_\nu(\omega)\]</div>
<p>which is true also for the lines. Here <span class="math notranslate nohighlight">\(\omega\)</span> is the direction,
<span class="math notranslate nohighlight">\(\nu\)</span> the frequency, <span class="math notranslate nohighlight">\(I\)</span> the intensity.  The emissivity
<span class="math notranslate nohighlight">\(j_\nu\)</span> and extinction <span class="math notranslate nohighlight">\(\alpha_\nu\)</span> for each line (given by
<span class="math notranslate nohighlight">\(i\)</span> =upper level and <span class="math notranslate nohighlight">\(j\)</span> =lower level) is given by:</p>
<div class="math notranslate nohighlight" id="eq-molec-extinct-def">
<span id="eq-molec-emis-def"></span>\[\begin{split}\begin{split}
j_{ij}(\Omega,\nu) &amp;= \frac{h\nu}{4\pi}Nn_iA_{ij}
\varphi_{ij}(\omega,\nu) \\
\alpha_{ij}(\omega,\nu) &amp;= \frac{h\nu}{4\pi}N(n_jB_{ji}-n_iB_{ij})
\varphi_{ij}(\omega,\nu)
\end{split}\end{split}\]</div>
<p>Here <span class="math notranslate nohighlight">\(N\)</span> is the number density of the molecule, <span class="math notranslate nohighlight">\(n_i\)</span> is the <em>fraction</em> of the molecules that are in level <span class="math notranslate nohighlight">\(i\)</span>, <span class="math notranslate nohighlight">\(A_{ij}\)</span> is the
Einstein coefficient for spontaneous emission from level <span class="math notranslate nohighlight">\(i\)</span> to level
<span class="math notranslate nohighlight">\(j\)</span>, and <span class="math notranslate nohighlight">\(B_{ij}\)</span> and <span class="math notranslate nohighlight">\(B_{ji}\)</span> are the Einstein-B-coefficients which obey:</p>
<div class="math notranslate nohighlight">
\[A_{ij}     = \frac{2h\nu_{ij}^3}{c^2} B_{ij},
B_{ji}g_j  = B_{ij} g_i\]</div>
<p>where <span class="math notranslate nohighlight">\(g\)</span> are the statistical weights of the levels, <span class="math notranslate nohighlight">\(h\)</span> the Planck constant
and <span class="math notranslate nohighlight">\(c\)</span> the light speed. The symbol <span class="math notranslate nohighlight">\(\varphi_{ij}(\omega,\nu)\)</span> is the line
profile function. For zero velocity field
<span class="math notranslate nohighlight">\(\varphi_{ij}(\omega,\nu)=\tilde\varphi_{ij}(\nu)\)</span>, i.e. the line profile
function is independent of direction. The tilde is to say that this is
the comoving line profile. It is given by</p>
<div class="math notranslate nohighlight">
\[\tilde\varphi_{ij}(\nu) = \frac{c}{a_{\mathrm{tot}}\nu_{ij}\sqrt{\pi}}
\exp\left(-\frac{c^2(\nu-\nu_{ij})^2}{a_{\mathrm{tot}}^2\nu_{ij}^2}\right)\]</div>
<p>where <span class="math notranslate nohighlight">\(\nu_{ij}\)</span> is the line-center frequency for the line and
<span class="math notranslate nohighlight">\(a_{\mathrm{tot}}\)</span> is the line width in units of cm/s. For pure
thermal broadning we have</p>
<div class="math notranslate nohighlight">
\[a_{\mathrm{tot}}=a_{\mathrm{therm}}=\sqrt{\frac{2kT_{\mathrm{gas}}}{m_{\mathrm{mol}}}}\]</div>
<p>where <span class="math notranslate nohighlight">\(m_{\mathrm{mol}}\)</span> is the weight of the molecule in gram, <span class="math notranslate nohighlight">\(k\)</span> is the
Boltzmann constant, <span class="math notranslate nohighlight">\(T_{\mathrm{gas}}\)</span> the gas temperature in K. As we shall
discuss in Section <a class="reference internal" href="#sec-turb-broadening"><span class="std std-ref">INPUT: The local microturbulent broadening (optional)</span></a>: we can also add
‘microturbulent line broadning’ <span class="math notranslate nohighlight">\(a_{\mathrm{turb}}\)</span>, also in cm/s:</p>
<div class="math notranslate nohighlight">
\[a_{\mathrm{tot}}=\sqrt{a^2_{\mathrm{turb}}+a^2_{\mathrm{therm}}}=
\sqrt{a^2_{\mathrm{turb}}+\frac{2kT_{\mathrm{gas}}}{m_{\mathrm{mol}}}}\]</div>
<p>When we have macroscopic velocities in our model, then the line profile
becomes angle-dependent (at a given lab-frame frequency):</p>
<div class="math notranslate nohighlight">
\[\varphi_{ij}(\omega,\nu) = \tilde\varphi_{ij}\big(\nu(1-\vec\omega\cdot \vec v/c)-\nu_{ij}\big)\]</div>
<p>The radiative transfer equation for non overlapping lines is then</p>
<div class="math notranslate nohighlight" id="eq-molec-rad-trans-eq">
\[\frac{dI_{ij}(\omega,\nu)}{ds} = j_{ij}(\omega,\nu) -
\alpha_{ij}(\omega,\nu) I_{ij}(\omega,\nu)\,.\]</div>
<p>But RADMC-3D naturally includes overlapping lines, at least in the
ray-tracing (for spectra and images). For non-LTE modes the line
overlapping is not yet (as of December 2011) included.</p>
</div>
<div class="section" id="line-transfer-modes-and-how-to-activate-the-line-transfer">
<span id="sec-line-trans-modes"></span><h2>Line transfer modes and how to activate the line transfer<a class="headerlink" href="#line-transfer-modes-and-how-to-activate-the-line-transfer" title="Permalink to this headline">¶</a></h2>
<p>Line transfer can be done in various different ways. This is controlled by the
global variable <code class="docutils literal notranslate"><span class="pre">lines_mode</span></code> (see below) and by the nature of the
molecular/atomic data (see discussion in Section <a class="reference internal" href="#sec-line-dot-inp"><span class="std std-ref">INPUT: The line.inp file</span></a>).</p>
<div class="section" id="two-different-atomic-molecular-data-file-types">
<h3>Two different atomic/molecular data file types<a class="headerlink" href="#two-different-atomic-molecular-data-file-types" title="Permalink to this headline">¶</a></h3>
<p>Let us start with the latter: RADMC-3D does not have any atomic or molecular
data hard-coded inside. It reads these data from data files that you provide.
There are two fundamentally different ways to feed atomic/molecular data into
RADMC-3D:</p>
<ul class="simple">
<li><p>Files containing the full level and line information (named <code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code>, where <code class="docutils literal notranslate"><span class="pre">XXX</span></code> is the name of the molecule or
atom). Atoms or molecules for which this data is provided can be treated
in LTE as well as in non-LTE.</p></li>
<li><p>Files containing only a line list (named <code class="docutils literal notranslate"><span class="pre">linelist_XXX.inp</span></code>, where <code class="docutils literal notranslate"><span class="pre">XXX</span></code> is the name of the molecule or
atom). Atoms or molecules for which this data is provided can only be
treated in LTE.</p></li>
</ul>
</div>
<div class="section" id="the-different-line-modes-the-lines-mode-parameter">
<span id="sec-lines-mode"></span><h3>The different line modes (the <code class="docutils literal notranslate"><span class="pre">lines_mode</span> <span class="pre">parameter</span></code>)<a class="headerlink" href="#the-different-line-modes-the-lines-mode-parameter" title="Permalink to this headline">¶</a></h3>
<p>For the atoms or molecules for which the full data are specified (the
<code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code> files) RADMC-3D has various different line
transfer modes, including different treatments of LTE or non-LTE. Which of
the modes you want RADMC-3D to use can be specified in the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file by setting the variable <code class="docutils literal notranslate"><span class="pre">lines_mode</span></code>, for
instance, by adding the following line to <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lines_mode</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>for LVG + Escape Probability populations. If no option is given, then the <em>LTE mode</em>
(<code class="docutils literal notranslate"><span class="pre">lines_mode=1</span></code>) is used.</p>
<p>The various line modes are:</p>
<ul>
<li><p><em>LTE mode (=default mode):</em> [<code class="docutils literal notranslate"><span class="pre">lines_mode=1</span></code>]</p>
<p>In this mode the line radiative transfer is done under LTE assumptions.</p>
</li>
<li><p><em>User-defined populations:</em> [<code class="docutils literal notranslate"><span class="pre">lines_mode=2</span></code>]</p>
<p>This calls the routine <code class="docutils literal notranslate"><span class="pre">userdef_compute_levelpop()</span></code> to compute
the level populations. This allows the user to specify the populations of
the levels of the molecules freely.</p>
</li>
<li><p><em>Large Velocity Gradient (Sobolev) populations:</em> [<code class="docutils literal notranslate"><span class="pre">lines_mode=3</span></code>]</p>
<p>This is one of the non-LTE modes of RADMC-3D. This mode calculates the
angle-averaged velocity gradient, and uses this to compute the level
populations according to the Large Velocity Gradient method (also often
called Sobolev’s method). This method is like an escape probability
method, where the escape probability is calculated based on the velocity
gradient. For this mode to work, the velocity field has to be read in, as
well as at least one of the number densities of the collision partners of
the molecule. See Section <a class="reference internal" href="#sec-lvg"><span class="std std-ref">Non-LTE Transfer: The Large Velocity Gradient (LVG) + Escape Probability (EscProb) method</span></a>.</p>
</li>
<li><p><em>Optically Thin non-LTE level populations method:</em> [<code class="docutils literal notranslate"><span class="pre">lines_mode=4</span></code>]</p>
<p>This is one of the non-LTE modes of RADMC-3D. This mode calculates the
non-LTE level populations under the assumption that all emitted line
radiation escapes and is not reabsorbed. For this mode to work, at least
one of the number densities of the collision partners of the molecule. See
Section <a class="reference internal" href="#sec-optthinpop"><span class="std std-ref">Non-LTE Transfer: The optically thin line assumption method</span></a>.</p>
</li>
<li><p><em>User-defined populations:</em> [<code class="docutils literal notranslate"><span class="pre">lines_mode=-10</span></code>]</p>
<p>This calls the routine <code class="docutils literal notranslate"><span class="pre">userdef_general_compute_levelpop()</span></code>
on-the-fly during the ray-tracing. This is very much like
<code class="docutils literal notranslate"><span class="pre">userdef_compute_levelpop()</span></code>, except that it leaves the
entire line-related stuff to the user: It does not read the molecular
data from a file. NOTE: This is a rather tricky mode, to be used only
if you know very well what you are doing…</p>
</li>
<li><p><em>Full non-LTE modes:</em> {bf Not yet ready}</p></li>
</ul>
<p>The default of the <code class="docutils literal notranslate"><span class="pre">lines_mode</span></code> variable is <code class="docutils literal notranslate"><span class="pre">lines_mode=1</span></code>.</p>
<p><strong>NOTE 1:</strong> Line emission is automatically included in the images and spectra if
RADMC-3D finds the file <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code> in the model directory. You can switch off
the lines with the command-line option <code class="docutils literal notranslate"><span class="pre">'noline'</span></code>.</p>
<p><strong>NOTE 2:</strong> If you are very limited by memory, and if you use LTE, LVG+EscProb
or optically thin populations, you can also ask RADMC-3D to <em>not</em> precalculate
the level populations before the rendering, but instead compute them
on-the-fly. This makes the code slower, but requires less memory.  You can do
this by choosing e.g. <code class="docutils literal notranslate"><span class="pre">lines_mode=-3</span></code> instead of <code class="docutils literal notranslate"><span class="pre">lines_mode=3</span></code> (for
LVG+EscProb).</p>
</div>
</div>
<div class="section" id="the-various-input-files-for-line-transfer">
<h2>The various input files for line transfer<a class="headerlink" href="#the-various-input-files-for-line-transfer" title="Permalink to this headline">¶</a></h2>
<div class="section" id="input-the-line-transfer-entries-in-the-radmc3d-inp-file">
<span id="sec-line-radmc-inp"></span><h3>INPUT: The line transfer entries in the radmc3d.inp file<a class="headerlink" href="#input-the-line-transfer-entries-in-the-radmc3d-inp-file" title="Permalink to this headline">¶</a></h3>
<p>Like all other modules of <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code>, also the line module
can be steered through keywords in the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file.
Here is a list:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">tgas_eq_tdust</span></code> (default: 0)</p>
<p>Normally you must specify the gas temperature at each grid cell using the
<code class="docutils literal notranslate"><span class="pre">gas_temperature.inp</span></code> file (or directly in the <code class="docutils literal notranslate"><span class="pre">userdef_module.f90</span></code>, see
Chapter <a class="reference internal" href="internalsetup.html#chap-internal-setup"><span class="std std-ref">Modifying RADMC-3D: Internal setup and user-specified radiative processes</span></a>). But sometimes you may want to compute
first the dust temperature and then set the gas temperature equal to the dust
temperature. You can do this obviously by hand: read the output dust
temperature and create the equivalent gas temperature input file from it. But
that is cumbersome.  By setting <code class="docutils literal notranslate"><span class="pre">tgas_eq_tdust=1</span></code> you tell <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code> to
simply read the <code class="docutils literal notranslate"><span class="pre">dust_temperature.inp</span></code> file and then equate the gas
temperature to the dust temperature. If multiple dust species are present,
only the first species will be used.</p>
</li>
</ul>
</div>
<div class="section" id="input-the-line-inp-file">
<span id="sec-line-dot-inp"></span><h3>INPUT: The line.inp file<a class="headerlink" href="#input-the-line-inp-file" title="Permalink to this headline">¶</a></h3>
<p>Like with the dust (which has this <code class="docutils literal notranslate"><span class="pre">dustopac.inp</span></code> master file,
also the line module has a master file: <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code>. It specifies
which molecules/atoms are to be modeled and in which file the
molecular/atomic data (such as the energy levels and the Einstein <span class="math notranslate nohighlight">\(A\)</span>
coefficients) are to be found</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iformat</span>                                  <span class="o">&lt;===</span> <span class="n">Put</span> <span class="n">this</span> <span class="n">to</span> <span class="mi">2</span>
<span class="n">N</span>                                        <span class="n">Nr</span> <span class="n">of</span> <span class="n">molecular</span> <span class="ow">or</span> <span class="n">atomic</span> <span class="n">species</span> <span class="n">to</span> <span class="n">be</span> <span class="n">modeled</span>
<span class="n">molname1</span> <span class="n">inpstyle1</span> <span class="n">iduma1</span> <span class="n">idumb1</span> <span class="n">ncol1</span>   <span class="n">Which</span> <span class="n">molecule</span> <span class="n">used</span> <span class="k">as</span> <span class="n">species</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">other</span> <span class="n">info</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">molnameN</span> <span class="n">inpstyleN</span> <span class="n">idumaN</span> <span class="n">idumbN</span> <span class="n">ncolN</span>   <span class="n">Which</span> <span class="n">molecule</span> <span class="n">used</span> <span class="k">as</span> <span class="n">species</span> <span class="n">N</span> <span class="o">+</span> <span class="n">other</span> <span class="n">info</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">N</span></code> is the number of molecular or atomic species you wish to
model. Typically this is 1. But if you want to <em>simultaneously</em> model for
instance the ortho-H<sub>2</sub>O and para-H<sub>2</sub>O infrared lines, you would
need to set this to 2.</p>
<p>The N lines following N (i.e. lines 3 to N+2) specify the molecule or atom, the
kind of input file format (explained below), and two integers which, at least
for now, can be simply set to 0 (see Section <a class="reference internal" href="#sec-line-selection"><span class="std std-ref">For experts: Selecting a subset of lines and levels ‘manually’</span></a> for the
meaning of these integers - for experts only), plus finally third integer, which
has to do with non-LTE transfer: the number of collision partners (set to 0 if
you only intend to do LTE transfer).</p>
<p>The molecule name can be e.g. <code class="docutils literal notranslate"><span class="pre">co</span></code> for carbon monoxide. The file
containing the data should then be called <code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code> (even
if it is an atom rather than a molecule; I could not find a good name which
means both molecule or atom). This file should be either generated by the
user, or (which is obviously the preferred option) taken from one of the
databases of molecular/atomic radiative properties. Since there are a number
of such databases and I want the code to be able to read those files without
the need of casting them into some special RADMC-3D format, <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code> allows the user to select which <em>kind</em> of file
the <code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code> (for CO) file is. At present only one
format is supported: the Leiden database. But more will follow. To
specify to <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code> to use the Leiden style, you put the
<code class="docutils literal notranslate"><span class="pre">inpstyle</span></code> to ‘leiden’. So here is a typical example of a
<code class="docutils literal notranslate"><span class="pre">lines.inp</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span>
<span class="mi">1</span>
<span class="n">co</span>   <span class="n">leiden</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>
</pre></div>
</div>
<p>This means: one molecule will be modeled, namely CO (and thus read from the file
<code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code>), and the data format is the Leiden database format.</p>
<p>NOTE: Since version 0.26 the file format number of this file <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code>
has increased. It is now 2, because in each line an extra integer is added.</p>
<p>NOTE: The files from the Leiden LAMDA database (see Section
<a class="reference internal" href="#sec-leiden-format"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a>) are usually called something like <code class="docutils literal notranslate"><span class="pre">co.dat</span></code>. You will
have to simply rename to <code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code>.</p>
<p>Most molecular data files have, in addition to the levels and radiative
rates, also the collision rates listed. See Section <a class="reference internal" href="#sec-leiden-format"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a>.
For non-LTE radiative transfer this is essential information. The number
densities of the collision partners (the particles with which the molecule
can collide and which can collisionally excited or de-excite the molecule)
are given in number density files with the same format as those of the
molecule itself (see Section <a class="reference internal" href="#sec-collpartner"><span class="std std-ref">INPUT: The number density of collision partners (for non-LTE transfer)</span></a>). However, we must tell
RADMC-3D to which collision partner particle the rate tables listed in the
<code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code> are associated (see Section
<a class="reference internal" href="#sec-collpartner"><span class="std std-ref">INPUT: The number density of collision partners (for non-LTE transfer)</span></a> for a better explanation of the issue here). This can
be done with the last of the integers in each line. Example: if the
<code class="docutils literal notranslate"><span class="pre">lines.inp</span></code> file reads:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span>
<span class="mi">1</span>
<span class="n">co</span>   <span class="n">leiden</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">2</span>
<span class="n">p</span><span class="o">-</span><span class="n">h2</span>
<span class="n">o</span><span class="o">-</span><span class="n">h2</span>
</pre></div>
</div>
<p>this means that the first collision rate table (starting with the number
<code class="docutils literal notranslate"><span class="pre">3.2e-11</span></code> in the example of Section <a class="reference internal" href="#sec-leiden-format"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a>) is for
collisions with particles for which the number density is given in the file
<code class="docutils literal notranslate"><span class="pre">numberdens_p-h2.inp</span></code> and the second collision rate table (starting with the
number <code class="docutils literal notranslate"><span class="pre">4.1e-11</span></code> in the example of Section <a class="reference internal" href="#sec-leiden-format"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a>) is for
collisions with particles for which the number density is given in the file
<code class="docutils literal notranslate"><span class="pre">numberdens_o-h2.inp</span></code>.</p>
<p>We could also decide to ignore the difference between para-H<span class="math notranslate nohighlight">\(_2\)</span> and
ortho-H<span class="math notranslate nohighlight">\(_2\)</span>, and simply use the first table (starting with the number
<code class="docutils literal notranslate"><span class="pre">3.2e-11</span></code> in the example of Section <a class="reference internal" href="#sec-leiden-format"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a>),
which is actually for para-H<span class="math notranslate nohighlight">\(_2\)</span> only, as a proxy for the overall mixture
of H<span class="math notranslate nohighlight">\(_2\)</span> molecules. After all: The collision rate for para-H<span class="math notranslate nohighlight">\(_2\)</span> and
ortho-H<span class="math notranslate nohighlight">\(_2\)</span> are not so very different. In that case we may simply ignore
this difference and only provide a file <code class="docutils literal notranslate"><span class="pre">numberdens_h2.inp</span></code>,
and link that to the first of the two collision rate tables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span>
<span class="mi">1</span>
<span class="n">co</span>   <span class="n">leiden</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">1</span>
<span class="n">h2</span>
</pre></div>
</div>
<p>(Note: we cannot, in this way, link this to the second of the two tables,
only to the first). But if we would do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span>
<span class="mi">1</span>
<span class="n">co</span>   <span class="n">leiden</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">3</span>
<span class="n">p</span><span class="o">-</span><span class="n">h2</span>
<span class="n">o</span><span class="o">-</span><span class="n">h2</span>
<span class="n">h</span>
</pre></div>
</div>
<p>we would get an error, because only two collision rate tables are
provided in <code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code>.</p>
<p>Finally, as we will explain in Section <a class="reference internal" href="#sec-linelist-xxx-inp"><span class="std std-ref">INPUT: Molecular/atomic data: The linelist_XXX.inp file(s)</span></a>, there
is an alternative way to feed atomic/molecular data into RADMC-3D: By using
linelists. To tell RADMC-3D to read a linelist file instead of a Leiden-style
molecular/atomic data file, just write the following in the <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code>
file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span>
<span class="mi">1</span>
<span class="n">h2o</span>  <span class="n">linelist</span> <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>
</pre></div>
</div>
<p>(example here is for water). This will make RADMC-3D read the
<code class="docutils literal notranslate"><span class="pre">linelist_h2o.inp</span></code> file as a linelist file (see Section
<a class="reference internal" href="#sec-linelist-xxx-inp"><span class="std std-ref">INPUT: Molecular/atomic data: The linelist_XXX.inp file(s)</span></a>). Note that lines from a linelist will always be in
LTE.</p>
<p>You can also have multiple species, for which some are of Leiden-style and some
are linelist style. For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span>
<span class="mi">2</span>
<span class="n">co</span>   <span class="n">leiden</span>   <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">2</span>
<span class="n">p</span><span class="o">-</span><span class="n">h2</span>
<span class="n">o</span><span class="o">-</span><span class="n">h2</span>
<span class="n">h2o</span>  <span class="n">linelist</span> <span class="mi">0</span>   <span class="mi">0</span>   <span class="mi">0</span>
</pre></div>
</div>
<p>Here the CO lines can be treated in a non-LTE manner (depending on what you put
for <code class="docutils literal notranslate"><span class="pre">lines_mode</span></code>, see Section <a class="reference internal" href="#sec-line-trans-modes"><span class="std std-ref">Line transfer modes and how to activate the line transfer</span></a>), and the
H<sub>2</sub>O is treated in LTE.</p>
</div>
<div class="section" id="input-molecular-atomic-data-the-molecule-xxx-inp-file-s">
<span id="sec-leiden-format"></span><span id="sec-molecule-xxx-inp"></span><h3>INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)<a class="headerlink" href="#input-molecular-atomic-data-the-molecule-xxx-inp-file-s" title="Permalink to this headline">¶</a></h3>
<p>As mentioned in Section <a class="reference internal" href="#sec-line-dot-inp"><span class="std std-ref">INPUT: The line.inp file</span></a> the atomic or molecular
fundamental data such as the level diagram and the radiative decay rates
(Einstein A coefficients) are read from a file (or more than one files) named
<code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code>, where the <code class="docutils literal notranslate"><span class="pre">XXX</span></code> is to be replaced by the name of the
molecule or atom in question. For these files RADMC-3D uses the Leiden LAMDA
database format. Note that, instead of a <code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code> file you can also
give a linelist file, but this will be discussed in Section
<a class="reference internal" href="#sec-linelist-xxx-inp"><span class="std std-ref">INPUT: Molecular/atomic data: The linelist_XXX.inp file(s)</span></a>.</p>
<p>The precise format of the Leiden database data files is of course described
in detail on their web
page <a class="reference external" href="http://www.strw.leidenuniv.nl/~moldata/">http://www.strw.leidenuniv.nl/~moldata/</a> . Here we only
give a very brief overview, based on an example of CO in which only the
first few levels are specified (taken from the LAMDA database):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!MOLECULE (Data from the LAMDA database)
CO
!MOLECULAR WEIGHT
28.0
!NUMBER OF ENERGY LEVELS
5
!LEVEL + ENERGIES(cm^-1) + WEIGHT + J
    1     0.000000000  1.0     0
    2     3.845033413  3.0     1
    3    11.534919938  5.0     2
    4    23.069512649  7.0     3
    5    38.448164669  9.0     4
!NUMBER OF RADIATIVE TRANSITIONS
4
!TRANS + UP + LOW + EINSTEINA(s^-1) + FREQ(GHz) + E_u(K)
    1     2     1   7.203e-08     115.2712018      5.53
    2     3     2   6.910e-07     230.5380000     16.60
    3     4     3   2.497e-06     345.7959899     33.19
    4     5     4   6.126e-06     461.0407682     55.32
</pre></div>
</div>
<p>The first few lines are self-explanatory. The first of the two tables is about
the levels. Column one is simply a numbering. Column 2 is the energy of the
level <span class="math notranslate nohighlight">\(E_k\)</span>, specified in units of <span class="math notranslate nohighlight">\(1/\mathrm{cm}\)</span>. To get the energy in erg
you multiply this number with <span class="math notranslate nohighlight">\(hc/k\)</span> where <span class="math notranslate nohighlight">\(h\)</span> is the Planck
constant, <span class="math notranslate nohighlight">\(c\)</span> the light speed and <span class="math notranslate nohighlight">\(k\)</span> the Boltzmann constant. Column
3 is the degeneration number, i.e. the the <span class="math notranslate nohighlight">\(g\)</span> parameter of the
level. Column 4 is redundant information, not used by the code.</p>
<p>The second table is the line list. Column 1 is again a simple counter.  Column 2
and 3 specify which two levels the line connects. Column 4 is the radiative
decay rate in units of <span class="math notranslate nohighlight">\(1/\mathrm{s}\)</span>, i.e. the Einstein <span class="math notranslate nohighlight">\(A\)</span>
coefficient. The last two columns are redundant information that can be easily
derived from the other information.</p>
<p>If you are interested in LTE line transfer, this is enough information.
However, if you want to use one of the non-LTE modes of RADMC-3D, you must
also have the collisional rate data. An example of a <code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code>
file that also contains these data is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!MOLECULE (Data from the LAMDA database)
CO
!MOLECULAR WEIGHT
28.0
!NUMBER OF ENERGY LEVELS
10
!LEVEL + ENERGIES(cm^-1) + WEIGHT + J
    1     0.000000000  1.0     0
    2     3.845033413  3.0     1
    3    11.534919938  5.0     2
    4    23.069512649  7.0     3
    5    38.448164669  9.0     4
!NUMBER OF RADIATIVE TRANSITIONS
9
!TRANS + UP + LOW + EINSTEINA(s^-1) + FREQ(GHz) + E_u(K)
    1     2     1   7.203e-08     115.2712018      5.53
    2     3     2   6.910e-07     230.5380000     16.60
    3     4     3   2.497e-06     345.7959899     33.19
    4     5     4   6.126e-06     461.0407682     55.32
!NUMBER OF COLL PARTNERS
2
!COLLISIONS BETWEEN
2 CO-pH2 from Flower (2001) &amp; Wernli et al. (2006) + extrapolation
!NUMBER OF COLL TRANS
10
!NUMBER OF COLL TEMPS
7
!COLL TEMPS
    5.0   10.0   20.0   30.0   50.0   70.0  100.0
!TRANS + UP + LOW + COLLRATES(cm^3 s^-1)
    1     2     1  3.2e-11 3.3e-11 3.3e-11 3.3e-11 3.4e-11 3.4e-11 3.4e-11
    2     3     1  2.9e-11 3.0e-11 3.1e-11 3.2e-11 3.2e-11 3.2e-11 3.2e-11
    3     3     2  7.9e-11 7.2e-11 6.5e-11 6.1e-11 5.9e-11 6.0e-11 6.5e-11
    4     4     1  4.8e-12 5.2e-12 5.6e-12 6.0e-12 7.1e-12 8.4e-12 1.2e-11
    5     4     2  4.7e-11 5.0e-11 5.1e-11 5.1e-11 5.1e-11 5.1e-11 5.1e-11
    6     4     3  9.0e-11 7.9e-11 7.1e-11 6.7e-11 6.5e-11 6.6e-11 7.2e-11
    7     5     1  2.8e-12 3.1e-12 3.4e-12 3.7e-12 4.0e-12 4.4e-12 4.0e-12
    8     5     2  8.0e-12 9.6e-12 1.1e-11 1.2e-11 1.4e-11 1.6e-11 2.2e-11
    9     5     3  5.9e-11 6.2e-11 6.2e-11 6.1e-11 6.0e-11 5.9e-11 5.8e-11
   10     5     4  8.5e-11 8.2e-11 7.5e-11 7.1e-11 6.9e-11 6.9e-11 7.3e-11
!COLLISIONS BETWEEN
3 CO-oH2 from Flower (2001) &amp; Wernli et al. (2006) + extrapolation
!NUMBER OF COLL TRANS
10
!NUMBER OF COLL TEMPS
7
!COLL TEMPS
    5.0   10.0   20.0   30.0   50.0   70.0  100.0
!TRANS + UP + LOW + COLLRATES(cm^3 s^-1)
    1     2     1  4.1e-11 3.8e-11 3.4e-11 3.3e-11 3.4e-11 3.5e-11 3.9e-11
    2     3     1  5.8e-11 5.6e-11 5.2e-11 5.0e-11 4.7e-11 4.7e-11 6.2e-11
    3     3     2  7.5e-11 7.1e-11 6.6e-11 6.2e-11 6.1e-11 6.2e-11 7.1e-11
    4     4     1  6.6e-12 7.1e-12 7.3e-12 7.5e-12 8.1e-12 9.0e-12 1.3e-11
    5     4     2  7.9e-11 8.3e-11 8.1e-11 7.8e-11 7.4e-11 7.3e-11 8.5e-11
    6     4     3  8.0e-11 7.5e-11 7.0e-11 6.8e-11 6.7e-11 6.9e-11 7.7e-11
    7     5     1  5.8e-12 6.1e-12 6.1e-12 6.1e-12 6.2e-12 6.3e-12 7.8e-12
    8     5     2  1.0e-11 1.2e-11 1.4e-11 1.4e-11 1.6e-11 1.8e-11 2.2e-11
    9     5     3  8.3e-11 8.9e-11 9.0e-11 8.8e-11 8.3e-11 8.1e-11 8.7e-11
   10     5     4  8.0e-11 7.9e-11 7.5e-11 7.2e-11 7.1e-11 7.1e-11 7.6e-11
</pre></div>
</div>
<p>As you see, the first part is the same. Now, however, there is extra
information.  First, the number of collision partners, for which these
collisional rate data is specified, is given. Then follows the reference to the
paper containing these data (this is not used by RADMC-3D; it is just for
information). Then the number of collisional transitions that are tabulated
(since collisions can relate any level to any other level, this number should
ideally be <code class="docutils literal notranslate"><span class="pre">nlevels*(nlevels-1)/2</span></code>, but this is not strictly enforced). Then
the number of temperature points at which these collisional rates are
tabulated. Then follows this list of temperatures.  Finally we have the table of
collisional transitions. Each line consists of, first, the ID of the transition
(dummy), then the upper level, then the lower level, and then the
<span class="math notranslate nohighlight">\(K_{\mathrm{up,low}}\)</span> collisional rates in units of [<span class="math notranslate nohighlight">\(\mathrm{cm}^3/s\)</span>]. The
same is again repeated (because in this example we have two collision partners:
the para-H<span class="math notranslate nohighlight">\(_2\)</span> molecule and the ortho-H<span class="math notranslate nohighlight">\(_2\)</span> molecule).</p>
<p>To get the collision rate <span class="math notranslate nohighlight">\(C_{\mathrm{up,low}}\)</span> per molecule (in units of
[1/s]) for the molecule of interest, we must multiply
<span class="math notranslate nohighlight">\(K_{\mathrm{up,low}}\)</span> with the number density of the collision partner
(see Section <a class="reference internal" href="#sec-collpartner"><span class="std std-ref">INPUT: The number density of collision partners (for non-LTE transfer)</span></a>).  So in this example, the
<span class="math notranslate nohighlight">\(C_{\mathrm{up,low}}\)</span> becomes:</p>
<div class="math notranslate nohighlight">
\[C_{\mathrm{up,low}} = N_{\mathrm{p-H}_2}K^{\mathrm{p-H}_2}_{\mathrm{up,low}}
+ N_{\mathrm{o-H}_2}K^{\mathrm{o-H}_2}_{\mathrm{up,low}}\]</div>
<p>The rates tabulated in this file are always the <em>downward</em> collision rate. The
upward rate is internally computed by RADMC-3D using the following formula:</p>
<div class="math notranslate nohighlight">
\[C_{\mathrm{low,up}} = C_{\mathrm{up,low}} \frac{g_{\mathrm{up}}}{g_{\mathrm{low}}}
\exp\left(-\frac{\Delta E}{kT}\right)\]</div>
<p>where the <span class="math notranslate nohighlight">\(g\)</span> factors are the statistical weights of the levels,
<span class="math notranslate nohighlight">\(\Delta E\)</span> is the energy difference between the levels, <span class="math notranslate nohighlight">\(k\)</span> is the
Boltzmann constant and <span class="math notranslate nohighlight">\(T\)</span> the gas temperature.</p>
<p>Some notes:</p>
<ul class="simple">
<li><p>When doing LTE transfer <em>and</em> you make RADMC-3D read a separate
file with the partition function (Section <a class="reference internal" href="#sec-partition-function"><span class="std std-ref">INPUT for LTE line transfer: The partition function (optional)</span></a>),
you can limit the <code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code> files to just the levels
and lines you are interested in. But again: You <em>must</em> then read the
partition function separately, and not let RADMC-3D compute it internally
based on the <code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code> file.</p></li>
<li><p>When doing non-LTE transfer and/or when you let RADMC-3D compute the
partition function internally you <em>must</em> make sure to include all
possible levels that might get populated, otherwise you may overpredict
the strength of the lines you are interested in.</p></li>
<li><p>The association of each of the collision partners in this file to
files that contain their spatial distribution is a bit complicated. See
Section <a class="reference internal" href="#sec-collpartner"><span class="std std-ref">INPUT: The number density of collision partners (for non-LTE transfer)</span></a>.</p></li>
</ul>
</div>
<div class="section" id="input-molecular-atomic-data-the-linelist-xxx-inp-file-s">
<span id="sec-linelist-xxx-inp"></span><h3>INPUT: Molecular/atomic data: The linelist_XXX.inp file(s)<a class="headerlink" href="#input-molecular-atomic-data-the-linelist-xxx-inp-file-s" title="Permalink to this headline">¶</a></h3>
<p>In many cases molecular data are merely given as lists of lines (e.g. the
HITRAN database, the Kurucz database, the Jorgensen et al. databases
etc.). These line lists contain information about the line wavelength
<span class="math notranslate nohighlight">\(\lambda_0\)</span>, the line strength <span class="math notranslate nohighlight">\(A_{\mathrm{ud}}\)</span>, the statistical
weights of the lower and upper level and the energy of the lower or upper
level. Sometimes also the name or set of quantum numbers of the levels, or
additional information about the line profile shapes are specified. These line
lists contain no <em>direct</em> information about the level diagram, although this
information can be extracted from the line list (if it is complete). These lines
lists also do not contain any information about collisional (de-)excitation, so
they cannot be used for non-LTE line transfer of any kind. They only work for
LTE line transfer. But such line lists are nevertheless used often (and thus LTE
is then assumed).</p>
<p>RADMC-3D can read the molecular data in line-list-form (files named
<code class="docutils literal notranslate"><span class="pre">linelist_XXX.inp</span></code>). RADMC-3D can in fact use both formats mixed (the line
list one and the ‘normal’ one of Section <a class="reference internal" href="#sec-molecule-xxx-inp"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a>). Some
molecules may be specified as line lists (<code class="docutils literal notranslate"><span class="pre">linelist_XXX.inp</span></code>) while
simultaneously others as full molecular files (<code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code>, see Section
<a class="reference internal" href="#sec-molecule-xxx-inp"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a>).  For the ‘linelist molecules’ RADMC-3D will then
automatically use LTE, while for the other molecules RADMC-3D will use the mode
according to the <code class="docutils literal notranslate"><span class="pre">lines_mode</span></code> value. This means that you can use this to have
mixed LTE and non-LTE species of molecules/atoms within the same model, as long
as the LTE ones have their molecular/atomic data given in a line list form. This
can be useful to model situations where most of the lines are in LTE, but one
(or a few) are non-LTE.</p>
<p>Now coming back to the linelist data. Here is an example of such a file
(created from data from the HITRAN database):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>! RADMC-3D Standard line list
! Format number:
1
! Molecule name:
h2o
! Reference: From the HITRAN Database (see below for more info)
! Molecular weight (in atomic units)
  18.010565
! Include table of partition sum? (0=no, 1=yes)
  1
! Include additional information? (0=no, 1=yes)
  0
! Nr of temperature points for the partition sum
    2931
!  Temp [K]      PartSum
 7.000000E+01  2.100000E+01
 7.100000E+01  2.143247E+01
 7.200000E+01  2.186765E+01
 7.300000E+01  2.230553E+01
....
....
....
 2.997000E+03  1.594216E+04
 2.998000E+03  1.595784E+04
 2.999000E+03  1.597353E+04
 3.000000E+03  1.598924E+04
! Nr of lines
  37432
! ID    Lambda [mic]  Aud [sec^-1]  E_lo [cm^-1]  E_up [cm^-1]  g_lo  g_up
     1  1.387752E+05  5.088000E-12  1.922829E+03  1.922901E+03   11.    9.
     2  2.496430E+04  1.009000E-09  1.907616E+03  1.908016E+03   21.   27.
     3  1.348270E+04  1.991000E-09  4.465107E+02  4.472524E+02   33.   39.
     4  1.117204E+04  8.314000E-09  2.129599E+03  2.130494E+03   27.   33.
     5  4.421465E+03  1.953000E-07  1.819335E+03  1.821597E+03   21.   27.
....
....
....
 37429  3.965831E-01  3.427000E-05  7.949640E+01  2.529490E+04   15.   21.
 37430  3.965250E-01  1.508000E-04  2.121564E+02  2.543125E+04   21.   27.
 37431  3.964335E-01  5.341000E-05  2.854186E+02  2.551033E+04   21.   27.
 37432  3.963221E-01  1.036000E-04  3.825169E+02  2.561452E+04   27.   33.
</pre></div>
</div>
<p>The file is pretty self-explanatory. It contains a table for the partition
function (necessary for LTE transfer) and a table with all the lines (or any
subset you wish to select). The lines table columns are as follows: first column
is just a dummy index. Second column is the wavelength in micron. Third is the
Einstein-A-coefficient (spontaneous downward rate) in units of
<span class="math notranslate nohighlight">\(\mathrm{s}^{-1}\)</span>. Fourth and fifth are the energies above the ground state of
the lower and upper levels belonging to this line in units of
<span class="math notranslate nohighlight">\(\mathrm{cm}^{-1}\)</span>. Sixth and seventh are the statistical weights (degenracies) of
the lower and upper levels belonging to this line.</p>
<p>Note that you can tell RADMC-3D to read <code class="docutils literal notranslate"><span class="pre">linelist_h2o.inp</span></code> (instead of search
for <code class="docutils literal notranslate"><span class="pre">molecule_h2o.inp</span></code>) by specifying <code class="docutils literal notranslate"><span class="pre">linelist</span></code> instead of <code class="docutils literal notranslate"><span class="pre">leiden</span></code> in
the <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code> file (see Section <a class="reference internal" href="#sec-line-dot-inp"><span class="std std-ref">INPUT: The line.inp file</span></a>).</p>
</div>
<div class="section" id="input-the-number-density-of-each-molecular-species">
<span id="sec-mol-numdensity"></span><h3>INPUT: The number density of each molecular species<a class="headerlink" href="#input-the-number-density-of-each-molecular-species" title="Permalink to this headline">¶</a></h3>
<p>For the line radiative transfer we need to know how many molecules of each
species are there per cubic centimeter. For molecular/atom species <code class="docutils literal notranslate"><span class="pre">XXX</span></code> this
is given in the file <code class="docutils literal notranslate"><span class="pre">numberdens_XXX.inp</span></code> (see Chapter <a class="reference internal" href="binaryio.html#chap-binary-io"><span class="std std-ref">Binary I/O files</span></a>
for the binary version of this file, which is more compact, and which you can
use instead of the ascii version). For each molecular/atomic species listed in
the <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code> file there must be a corresponding <code class="docutils literal notranslate"><span class="pre">numberdens_XXX.inp</span></code>
file. The structure of the file is very similar (though not identical) to the
structure of the dust density input file <code class="docutils literal notranslate"><span class="pre">dust_density.inp</span></code> (Section
<a class="reference internal" href="inputoutputfiles.html#sec-dustdens"><span class="std std-ref">INPUT (required for dust transfer): dust_density.inp</span></a>). For the precise way to address the various cells in the
different AMR modes, we refer to Section <a class="reference internal" href="inputoutputfiles.html#sec-dustdens"><span class="std std-ref">INPUT (required for dust transfer): dust_density.inp</span></a>, where this is
described in detail.</p>
<p>For formatted style (<code class="docutils literal notranslate"><span class="pre">numberdens_XXX.inp</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iformat</span>                                  <span class="o">&lt;===</span> <span class="n">Typically</span> <span class="mi">1</span> <span class="n">at</span> <span class="n">present</span>
<span class="n">nrcells</span>
<span class="n">numberdensity</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">..</span>
<span class="n">numberdensity</span><span class="p">[</span><span class="n">nrcells</span><span class="p">]</span>
</pre></div>
</div>
<p>The number densities are to be specified in units of molecule per cubic
centimeter.</p>
</div>
<div class="section" id="input-the-gas-temperature">
<span id="sec-gas-temperature"></span><h3>INPUT: The gas temperature<a class="headerlink" href="#input-the-gas-temperature" title="Permalink to this headline">¶</a></h3>
<p>For line transfer we need to know the gas temperature. You specify this in the
file <code class="docutils literal notranslate"><span class="pre">gas_temperature.inp</span></code> (see Chapter <a class="reference internal" href="binaryio.html#chap-binary-io"><span class="std std-ref">Binary I/O files</span></a> for the binary
version of these files, which are more compact, and which you can use instead of
the ascii versions). The structure of this file is identical to that described
in Section <a class="reference internal" href="#sec-mol-numdensity"><span class="std std-ref">INPUT: The number density of each molecular species</span></a>, but of course with number density replaced
by gas temperature in Kelvin. For the precise way to address the various cells
in the different AMR modes, we refer to Section <a class="reference internal" href="inputoutputfiles.html#sec-dustdens"><span class="std std-ref">INPUT (required for dust transfer): dust_density.inp</span></a>, where this
is described in detail.</p>
<p>Note: Instead of literally specifying the gas temperature you can also tell
<code class="docutils literal notranslate"><span class="pre">radmc3d</span></code> to copy the dust temperature (if it know it) into the gas
temperature. See the keyword <code class="docutils literal notranslate"><span class="pre">tgas_eq_tdust</span></code> described in Section
<a class="reference internal" href="#sec-line-radmc-inp"><span class="std std-ref">INPUT: The line transfer entries in the radmc3d.inp file</span></a>.</p>
</div>
<div class="section" id="input-the-velocity-field">
<span id="sec-velo-field"></span><h3>INPUT: The velocity field<a class="headerlink" href="#input-the-velocity-field" title="Permalink to this headline">¶</a></h3>
<p>Since gas motions are usually the main source of Doppler shift or broadening in
astrophysical settings, it is obligatory to specify the gas velocity.  This can
be done with the file <code class="docutils literal notranslate"><span class="pre">gas_velocity.inp</span></code> (see Chapter <a class="reference internal" href="binaryio.html#chap-binary-io"><span class="std std-ref">Binary I/O files</span></a>
for the binary version of these files, which are more compact, and which you can
use instead of the ascii versions). The structure is again similar to that
described in Section <a class="reference internal" href="#sec-mol-numdensity"><span class="std std-ref">INPUT: The number density of each molecular species</span></a>, but now with three numbers at
each grid point instead of just one. The three numbers are the velocity in
<span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(z\)</span> direction for Cartesian coordinates, or in
<span class="math notranslate nohighlight">\(r\)</span>, <span class="math notranslate nohighlight">\(\theta\)</span> and <span class="math notranslate nohighlight">\(\phi\)</span> direction for spherical
coordinates. Note that both in cartesian coordinates and in spherical
coordinates <em>all</em> velocity components have the same dimension of cm/s. For
spherical coordinates the conventions are: positive <span class="math notranslate nohighlight">\(v_r\)</span> points outwards,
positive <span class="math notranslate nohighlight">\(v_\theta\)</span> points downward (toward larger <span class="math notranslate nohighlight">\(\theta\)</span>) for
<span class="math notranslate nohighlight">\(0&lt;\theta&lt;\pi\)</span> (where ‘downward’ is toward smaller <span class="math notranslate nohighlight">\(z\)</span>), and
positive <span class="math notranslate nohighlight">\(v_\phi\)</span> means velocity in counter-clockwise direction in the
<span class="math notranslate nohighlight">\(x,y\)</span>-plane.</p>
<p>For the precise way to address the various cells in the different AMR modes,
we refer to Section <a class="reference internal" href="inputoutputfiles.html#sec-dustdens"><span class="std std-ref">INPUT (required for dust transfer): dust_density.inp</span></a>, where this is described in detail.</p>
</div>
<div class="section" id="input-the-local-microturbulent-broadening-optional">
<span id="sec-turb-broadening"></span><h3>INPUT: The local microturbulent broadening (optional)<a class="headerlink" href="#input-the-local-microturbulent-broadening-optional" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code> code automatically includes thermal broadening of the line. But
sometimes it is also useful to specify a local (spatially unresolved) turbulent
width. This is not obligatory (if it is not specified, only the thermal
broadening is used) but if you want to specify it, you can do so in the file
<code class="docutils literal notranslate"><span class="pre">microturbulence.inp</span></code> (see Chapter <a class="reference internal" href="binaryio.html#chap-binary-io"><span class="std std-ref">Binary I/O files</span></a> for the binary
version of these files, which are more compact, and which you can use instead of
the ascii versions). The file format is the same structure as described in
Section <a class="reference internal" href="#sec-mol-numdensity"><span class="std std-ref">INPUT: The number density of each molecular species</span></a>. For the precise way to address the various
cells in the different AMR modes, we refer to Section <a class="reference internal" href="inputoutputfiles.html#sec-dustdens"><span class="std std-ref">INPUT (required for dust transfer): dust_density.inp</span></a>, where
this is described in detail.</p>
<p>Here is the way it is included into the line profile:</p>
<div class="math notranslate nohighlight">
\[a_{\mathrm{linewidth}}^2 = a^2_{\mathrm{turb}} + \frac{2kT_{\mathrm{gas}}}{\mu}\]</div>
<p>where <span class="math notranslate nohighlight">\(T_{\mathrm{gas}}\)</span> is the temperature of the gas, <span class="math notranslate nohighlight">\(\mu\)</span> the
molecular weight, <span class="math notranslate nohighlight">\(k\)</span> the Boltzmann constant and <span class="math notranslate nohighlight">\(a_{\mathrm{turb}}\)</span>
the microturbulent line width in units of cm/s. The
<span class="math notranslate nohighlight">\(a_{\mathrm{linewidth}}\)</span> is then the total (thermal plus microturbulent)
line width.</p>
</div>
<div class="section" id="input-for-lte-line-transfer-the-partition-function-optional">
<span id="sec-partition-function"></span><h3>INPUT for LTE line transfer: The partition function (optional)<a class="headerlink" href="#input-for-lte-line-transfer-the-partition-function-optional" title="Permalink to this headline">¶</a></h3>
<p>If you use the LTE mode (either <code class="docutils literal notranslate"><span class="pre">lines_mode=-1</span></code> or <code class="docutils literal notranslate"><span class="pre">lines_mode=1</span></code>), then the partition function is required to calculate, for
a given temperature the populations of the various levels. Since this
involves a summation over <em>all</em> levels of all kinds that can possibly be
populated, and since the molecular/atomic data file may not include all
these possible levels, it may be useful to look the partition function up in
some literature and give this to <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code>. This can be done with
the file <code class="docutils literal notranslate"><span class="pre">partitionfunction_XXX.inp</span></code>, where again <code class="docutils literal notranslate"><span class="pre">XXX</span></code>
is here a placeholder for the actual name of the molecule at hand. If you do
not have this file in the present model directory, then <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code>
will compute the partition function itself, but based on the (maybe limited)
set of levels given in the molecular data file. The structure of the
<code class="docutils literal notranslate"><span class="pre">partitionfunction_XXX.inp</span></code> file is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iformat</span>                    <span class="p">;</span> <span class="n">The</span> <span class="n">usual</span> <span class="nb">format</span> <span class="n">number</span><span class="p">,</span> <span class="n">currently</span> <span class="mi">1</span>
<span class="n">ntemp</span>                      <span class="p">;</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">temperatures</span> <span class="n">at</span> <span class="n">which</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">specified</span>
<span class="n">temp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>       <span class="n">pfunc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">temp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>       <span class="n">pfunc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="o">.</span>             <span class="o">.</span>
  <span class="o">.</span>             <span class="o">.</span>
  <span class="o">.</span>             <span class="o">.</span>
<span class="n">temp</span><span class="p">(</span><span class="n">ntemp</span><span class="p">)</span>   <span class="n">pfunc</span><span class="p">(</span><span class="n">ntemp</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>NOTE:</strong> RADMC-3D assumes the partition function to be defined in the following
way:</p>
<div class="math notranslate nohighlight">
\[Z(T) = \sum_{i=1} g_ie^{-(E_i-E_1)/kT}\]</div>
<p>In other words: the first level is assumed to be the ground state. This is done
so that one can also use an energy definition in which the ground state energy
is non-zero (example: Hydrogen <span class="math notranslate nohighlight">\(E_1=-13.6\)</span> eV). If you use molecular line
datafiles that contain only a subset of levels (which is in principle no problem
for LTE calculations) then it is essential that the ground state is included in
this list, and that it is the first level (<code class="docutils literal notranslate"><span class="pre">ilevel=1</span></code>).</p>
</div>
<div class="section" id="input-the-number-density-of-collision-partners-for-non-lte-transfer">
<span id="sec-collpartner"></span><h3>INPUT: The number density of collision partners (for non-LTE transfer)<a class="headerlink" href="#input-the-number-density-of-collision-partners-for-non-lte-transfer" title="Permalink to this headline">¶</a></h3>
<p>For non-LTE line transfer (see e.g. Sections <a class="reference internal" href="#sec-lvg"><span class="std std-ref">Non-LTE Transfer: The Large Velocity Gradient (LVG) + Escape Probability (EscProb) method</span></a>,
<a class="reference internal" href="#sec-optthinpop"><span class="std std-ref">Non-LTE Transfer: The optically thin line assumption method</span></a>) the molecules can be collisionally excited. The collision
rates for each pair of molecule + collision partner are given in the molecular
input data files (Section <a class="reference internal" href="#sec-molecule-xxx-inp"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a>). To find how often a
molecular level of a single molecule is collisionally excited to another level
we also need to know the number density of the collision partner molecules. In
the example in Section <a class="reference internal" href="#sec-molecule-xxx-inp"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a> these were para-H<span class="math notranslate nohighlight">\(_2\)</span>
and ortho-H<span class="math notranslate nohighlight">\(_2\)</span>. We must therefore somehow tell RADMC-3D what the number
densities of these molecules are. This is done by reading in the number
densities for this(these) collision partner(s).  The file for this has exactly
the same format as that for the number density of any molecule (see Section
<a class="reference internal" href="#sec-mol-numdensity"><span class="std std-ref">INPUT: The number density of each molecular species</span></a>). So for our example we would thus have two files,
which could be named <code class="docutils literal notranslate"><span class="pre">numberdens_p-h2.inp</span></code> and <code class="docutils literal notranslate"><span class="pre">numberdens_o-h2.inp</span></code>
respectively.  See Section <a class="reference internal" href="#sec-mol-numdensity"><span class="std std-ref">INPUT: The number density of each molecular species</span></a> for details.</p>
<p>However, how does RADMC-3D know that the first collision partner of CO is called
<code class="docutils literal notranslate"><span class="pre">p-h2</span></code> and the second <code class="docutils literal notranslate"><span class="pre">o-h2</span></code>?  In principle the file <code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code>
give some information about the name of the collision partners. But this is
often not machine-readable.  Example, in <code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code> of Section
<a class="reference internal" href="#sec-molecule-xxx-inp"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a> the line that should tell this reads:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span> <span class="n">CO</span><span class="o">-</span><span class="n">pH2</span> <span class="kn">from</span> <span class="nn">Flower</span> <span class="p">(</span><span class="mi">2001</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Wernli</span> <span class="n">et</span> <span class="n">al</span><span class="o">.</span> <span class="p">(</span><span class="mi">2006</span><span class="p">)</span> <span class="o">+</span> <span class="n">extrapolation</span>
</pre></div>
</div>
<p>for the first of the two
(which is directly from the LAMDA database).  This is hard to decipher for
RADMC-3D. Therefore you have to tell this explicitly in the file <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code>,
and we refer to Section <a class="reference internal" href="#sec-line-dot-inp"><span class="std std-ref">INPUT: The line.inp file</span></a> for how to do this.</p>
</div>
</div>
<div class="section" id="making-images-and-spectra-with-line-transfer">
<h2>Making images and spectra with line transfer<a class="headerlink" href="#making-images-and-spectra-with-line-transfer" title="Permalink to this headline">¶</a></h2>
<p>Making images and spectra with/of lines works in the same way as for the
continuum. RADMC-3D will check if the file <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code> is present in your
directory, and if so, it will automatically switch on the line transfer. If you
insist on <em>not</em> having the lines switched on, in spite of the presence of the
<code class="docutils literal notranslate"><span class="pre">lines.inp</span></code> file, you can add the option <code class="docutils literal notranslate"><span class="pre">noline</span></code> to <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code> on the
command line. If you don’t, then lines are normally automatically switched on,
except in situations where it is obviously not required.</p>
<p>You can just make an image at some wavelength and you’ll get the image with
any line emission included if it is there. For instance, if you have
the molecular data of CO included, then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">image</span> <span class="k">lambda</span> <span class="mf">2600.757</span>
</pre></div>
</div>
<p>will give an image right at the CO 1-0 line center. The code will automatically
check if (and if yes, which) line(s) are contributing to the wavelength of
interest. Also it will include all the continuum emission (and absorption) that
you would usually obtain.</p>
<p>There is, however, an exception to this automatic line inclusion: If you make a
spectral energy distribution (with the command <code class="docutils literal notranslate"><span class="pre">sed</span></code>, see Section
<a class="reference internal" href="imagesspectra.html#sec-making-spectra"><span class="std std-ref">Making spectra</span></a>), then lines are not included. The same is true if you
use the <code class="docutils literal notranslate"><span class="pre">loadcolor</span></code> command.  But for normal spectra or images the line
emission will automatically be included.  So if you make a spectrum at
wavelength around some line, you will get a spectrum including the line profile
from the object, as well as the dust continuum.</p>
<p>It is not always convenient to have to know by heart the exact wavelengths
of the lines you are interested in. So RADMC-3D allows you to specify the
wavelength by specifying which line of which molecule, and at which velocity
you want to render:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">image</span> <span class="n">iline</span> <span class="mi">2</span> <span class="n">vkms</span> <span class="mf">2.4</span>
</pre></div>
</div>
<p>If you have CO as your molecule, then iline 2 means CO 2-1 (the second
line in the rotational ladder).</p>
<p>By default the first molecule is used (if you have more than one molecule),
but you can also specify another one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">image</span> <span class="n">imolspec</span> <span class="mi">2</span> <span class="n">iline</span> <span class="mi">2</span> <span class="n">vkms</span> <span class="mf">2.4</span>
</pre></div>
</div>
<p>which would select the second molecule instead of the first one.</p>
<p>If you wish to make an entire spectrum of the line, you can do for instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">spectrum</span> <span class="n">iline</span> <span class="mi">1</span> <span class="n">widthkms</span> <span class="mi">10</span>
</pre></div>
</div>
<p>which produces a spectrum of the line with a passband going from -10 km/s to
+10 km/s. By default 40 wavelength points are used, and they are evenly
spaced. You can set this number of wavelengths:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">spectrum</span> <span class="n">iline</span> <span class="mi">1</span> <span class="n">widthkms</span> <span class="mi">10</span> <span class="n">linenlam</span> <span class="mi">100</span>
</pre></div>
</div>
<p>which would make a spectrum with 100 wavelength points, evenly spaced around
the line center. You can also shift the passband center:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">spectrum</span> <span class="n">iline</span> <span class="mi">1</span> <span class="n">widthkms</span> <span class="mi">10</span> <span class="n">linenlam</span> <span class="mi">100</span> <span class="n">vkms</span> <span class="o">-</span><span class="mi">10</span>
</pre></div>
</div>
<p>which would make the wavelength grid 10 kms shifted in short direction.</p>
<p>Note that you can use the <code class="docutils literal notranslate"><span class="pre">widthkms</span></code> and <code class="docutils literal notranslate"><span class="pre">linenlam</span></code> keywords also for
images:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">image</span> <span class="n">iline</span> <span class="mi">1</span> <span class="n">widthkms</span> <span class="mi">10</span> <span class="n">linenlam</span> <span class="mi">100</span>
</pre></div>
</div>
<p>This will make a multi-color image, i.e. it will make images at 100 wavelenths
points evenly spaced around the line center. In this way you can make channel
maps.</p>
<p>For more details on how to specify the spectral sampling, please read Section
<a class="reference internal" href="imagesspectra.html#sec-set-camera-frequencies"><span class="std std-ref">Specifying custom-made sets of wavelength points for the camera</span></a>. Note that keywords such as <code class="docutils literal notranslate"><span class="pre">incl</span></code>, <code class="docutils literal notranslate"><span class="pre">phi</span></code>,
and any other keywords specifying the camera position, zooming factor etc, can
all be used in addition to the above keywords.</p>
<div class="section" id="speed-versus-realism-of-rendering-of-line-images-spectra">
<span id="sec-line-render-speed-realism"></span><h3>Speed versus realism of rendering of line images/spectra<a class="headerlink" href="#speed-versus-realism-of-rendering-of-line-images-spectra" title="Permalink to this headline">¶</a></h3>
<p>As usual with numerical modeling: including realism to the modeling goes at
the cost of rendering speed. A ‘fully realistic’ rendering of a model
spectrum or image of a gas line involves (assuming the level populations
are already known):</p>
<ol class="arabic simple">
<li><p>Doppler-shifted emission and absorption.</p></li>
<li><p>Inclusion of dust thermal emission and dust extinction while rendering
the lines.</p></li>
<li><p>Continuum emission scattered by dust into the line-of-sight</p></li>
<li><p>Line emission from (possibly obscured) other regions is allowed to
scatter into the line-of-sight by dust grains (see Section
<a class="reference internal" href="#sec-line-scat-off-dust"><span class="std std-ref">Line emission scattered off dust grains</span></a>).</p></li>
</ol>
<p>RADMC-3D always includes the Doppler shifts. By default, RADMC-3D also
includes dust thermal emission and extinction, as well as the scattered
continuum radiation.</p>
<p><em>For many lines, however, dust continuum scattering is a negligible
portion of the flux, so you can speed things up by not including dust
scattering!</em> This can be easily done by adding the <code class="docutils literal notranslate"><span class="pre">noscat</span></code>
option on the command-line when you issue the command for a line spectrum or
multi-frequency image. This way, the scattering source function is not
computed (is assumed to be zero), and no scattering Monte Carlo runs are
necessary. This means that the ray-tracer can now render all wavelength
simultaneously (each ray doing all wavelength at the same time), and the
local level populations along each ray can now be computed once, and be used
for all wavelengths. <em>This may speed up things drastically, and for most
purposes virtually perfectly correct</em>. Just beware that when you render
short-wavelength lines (optical) or you use large grains, i.e. when the
scattering albedo at the wavelength of the line is not negligible, this may
result in a mis-estimation of the continuum around the line.</p>
</div>
<div class="section" id="line-emission-scattered-off-dust-grains">
<span id="sec-line-scat-off-dust"></span><h3>Line emission scattered off dust grains<a class="headerlink" href="#line-emission-scattered-off-dust-grains" title="Permalink to this headline">¶</a></h3>
<p><em>NOTE: The contents of this subsection may not be 100% implemented yet.</em></p>
<p>Also any line emission from obscured regions that get scattered into the
line of sight by the dust (if dust scattering is included) will be
included. Note, however, that any possible Doppler shift <em>induced</em> by
this scattering is <em>not</em> included. This means that if line emission is
scattered by a dust cloud moving at a very large speed, then this line
emission will be scattered by the dust, but no Doppler shift at the
projected velocity of the dust will be added. Only the Doppler shift of the
line-emitting region is accounted for. This is rarely a problem, because
typically the dust that may scatter line emission is located far away from
the source of line emission and moves at substantially lower speed.</p>
</div>
</div>
<div class="section" id="non-lte-transfer-the-large-velocity-gradient-lvg-escape-probability-escprob-method">
<span id="sec-lvg"></span><h2>Non-LTE Transfer: The Large Velocity Gradient (LVG) + Escape Probability (EscProb) method<a class="headerlink" href="#non-lte-transfer-the-large-velocity-gradient-lvg-escape-probability-escprob-method" title="Permalink to this headline">¶</a></h2>
<p>The assumption that the energy levels of a molecule or atom are always
populated according to a thermal distribution (the so-called ‘local
thermodynamic equilibrium’, or LTE, assumption) is valid under certain
circumstances. For instance for planetary atmospheres in most cases.  But in
the dilute interstellar medium this assumption is very often invalid.  One
must then compute the level populations consistent with the local density
and temperature, and often also consistent with the local radiation
field. Part of this radiation field might even be the emission from the
lines themselves, meaning that the molecules radiatively influence their
neighbors. Solving the level populations self-consistently is called
‘non-LTE radiative transfer’. A full non-LTE radiative transfer
calculation is, however, in most cases (a) too numerically demanding and
sometimes (b) unnecessary. Sometimes a simple approximation of the non-LTE
effects is sufficient.</p>
<p>One such approximation method is the ‘Large Velocity Gradient’ (LVG)
method, also called the ‘Sobolev approximation’.  Please read for instance
the paper by Ossenkopf (1997) ‘The Sobolev approximation in molecular
clouds’, New Astronomy, 2, 365 for more explanation, and a study how it
works in the context of molecular clouds. The LVG mode of RADMC-3D has been
used for the first time by Shetty et al. (2011, MNRAS 412, 1686), and a
description of the method is included in that paper.  The nice aspect of
this method is that it is, for most part, local. The only slightly non-local
aspect is that a velocity gradient has to be computed by comparing the gas
velocity in one cell with the gas velocity in neighboring cells.</p>
<p>As of RADMC-3D Version 0.33 the LVG method is combined with an escape
probability (EscProb) method. In fact, LVG <em>is</em> a kind of escape probability
method itself. It is just that for the classic EscProb method the photons can
escape due to the finite size of the object, and thus the finite optical
depth in the lines. In the LVG the object size is not the issue, but the
gradient of the velocity. The line width combined with the velocity gradient
give a length scale over which a photon can escape.</p>
<p>In the LVG + EscProb method the line-integrated mean intensity <span class="math notranslate nohighlight">\(J_{ij}\)</span> is
given by</p>
<div class="math notranslate nohighlight" id="eq-linemeanint-escp">
\[J_{ij} = (1-\beta_{ij})S_{ij} + \beta_{ij}J_{ij}^{\mathrm{bg}}\]</div>
<p>where <span class="math notranslate nohighlight">\(J_{ij}^{\mathrm{bg}}\)</span> is the mean intensity of the background
radiation field at frequency <span class="math notranslate nohighlight">\(\nu=\nu_{ij}\)</span> (default is blackbody at 2.73 K,
but this temperature can be varied with the <code class="docutils literal notranslate"><span class="pre">lines_tbg</span></code> variable
in <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code>), while <span class="math notranslate nohighlight">\(\beta_{ij}\)</span> is the escape probability
for line <span class="math notranslate nohighlight">\(i\rightarrow j\)</span>. This is given by</p>
<div class="math notranslate nohighlight" id="eq-escprob-beta-formula">
\[\beta_{ij} = \frac{1-\exp(-\tau_{ij})}{\tau_{ij}}\]</div>
<p>where <span class="math notranslate nohighlight">\(\tau_{ij}\)</span> is the line-center optical depth in the line.</p>
<p>For the LVG method this optical depth is given by the velocity gradient:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{split}
\tau_{ij}^{\mathrm{LVG}} &amp; = \frac{ch}{4\pi}\frac{N_{\mathrm{molec}}}
{1.064\,|\nabla \vec v|}\left[n_jB_{ji}-n_iB_{ij}\right]\\
&amp;= \frac{c^3}{8\pi \nu_{ij}^3}\frac{A_{ij}N_{\mathrm{molec}}}
{1.064\,|\nabla \vec v|}\left[\frac{g_i}{g_j}n_j-n_i\right]
\end{split}\end{split}\]</div>
<p>(see e.g. van der Tak et al. 2007, A&amp;A 468, 627), where <span class="math notranslate nohighlight">\(n_i\)</span> is the
fractional level population of level <span class="math notranslate nohighlight">\(i\)</span>, <span class="math notranslate nohighlight">\(N_{\mathrm{molec}}\)</span> the
total number density of the molecule, <span class="math notranslate nohighlight">\(|\nabla \vec v|\)</span> the absolute value
of the velocity gradient, <span class="math notranslate nohighlight">\(g_i\)</span> the statistical weight of level <span class="math notranslate nohighlight">\(i\)</span>
and <span class="math notranslate nohighlight">\(\nu_{ij}\)</span> the line frequency for transition <span class="math notranslate nohighlight">\(i\rightarrow
j\)</span>. In comparing to Eq. 21 of van der Tak’s paper, note that their
<span class="math notranslate nohighlight">\(N_{\mathrm{mol}}\)</span> is a column density (cm<span class="math notranslate nohighlight">\(^{-2}\)</span>) and their
<span class="math notranslate nohighlight">\(\Delta V\)</span> is the line width (cm/s), while our <span class="math notranslate nohighlight">\(N_{\mathrm{molec}}\)</span>
is the number density (cm<span class="math notranslate nohighlight">\(^{-3}\)</span>) and <span class="math notranslate nohighlight">\(|\nabla \vec v|\)</span> is the
velocity gradient (s<span class="math notranslate nohighlight">\(^{-1}\)</span>). Their formula is thus in fact EscProb while
ours is LVG.</p>
<p>For the EscProb method <em>without</em> velocity gradients, we need to be able to
compute the total column depth <span class="math notranslate nohighlight">\(\Sigma_{\mathrm{molec}}\)</span> in the direction
where this <span class="math notranslate nohighlight">\(\Sigma_{\mathrm{molec}}\)</span> is minimal. This is something that,
at the moment, RADMC-3D cannot yet do. But this is something that can be
estimated based on a ‘typical length scale’ <span class="math notranslate nohighlight">\(L\)</span>, such that</p>
<div class="math notranslate nohighlight">
\[\Sigma_{\mathrm{molec}} \simeq N_{\mathrm{molec}}\, L\]</div>
<p>RADMC-3D allows you to specify <span class="math notranslate nohighlight">\(L\)</span> separately for each cell (in the file
<code class="docutils literal notranslate"><span class="pre">escprob_lengthscale.inp</span></code> or its binary version). The simplest would be to set
it to a global value equal to the typical size of the object we are interested
in. Then the line-center optical depth, assuming a Gaussian line profile with
width <span class="math notranslate nohighlight">\(a_{\mathrm{linewidth}}\)</span>, is</p>
<div class="math notranslate nohighlight">
\[\tau_{ij}^{\mathrm{EscProb}} = \frac{hc \Sigma_{\mathrm{molec}}}{4\pi\sqrt{\pi}\,a_{\mathrm{linewidth}}}\left[n_jB_{ji}-n_iB_{ij}\right]\]</div>
<p>because <span class="math notranslate nohighlight">\(\phi(\nu=\nu_{ij})=c/(a\nu_{ij}\sqrt{\pi})\)</span>.</p>
<p>The optical depth of the combined LVG + EscProb method is then:</p>
<div class="math notranslate nohighlight">
\[\tau_{ij} = \mathrm{min}\left(\tau_{ij}^{\mathrm{LVG}},\tau_{ij}^{\mathrm{EscProb}}\right)\]</div>
<p>This is then the <span class="math notranslate nohighlight">\(\tau_{ij}\)</span> that needs to be inserted into
Eq. (<span class="xref std std-ref">eq-escprob-beta-formula</span>) for obtaining the escape probability
<span class="math notranslate nohighlight">\(\beta_{ij}\)</span> (which includes escape due to LVG as well as the finite
length scale <span class="math notranslate nohighlight">\(L\)</span>).</p>
<p>The LVG+EscProb method solves at each location the following statistical
equilibrium equation:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{split}
&amp; \sum_{j&gt;i} \Big[ n_jA_{ji} + (n_jB_{ji}-n_iB_{ij})J_{ji}\Big]\\
&amp; - \sum_{j&lt;i} \Big[ n_iA_{ij} + (n_iB_{ij}-n_jB_{ji})J_{ij}\Big]\\
&amp; + \sum_{j\neq i}\big[n_jC_{ji}-n_iC_{ij}\big]=0
\end{split}\end{split}\]</div>
<p>Replacing <span class="math notranslate nohighlight">\(J_{ij}\)</span> (and similarly <span class="math notranslate nohighlight">\(J_{ji}\)</span>) with the expression of
Eq. (<span class="xref std std-ref">eq-linemeanint-escp</span>) and subsequently replacing <span class="math notranslate nohighlight">\(S_{ij}\)</span> with
the well-known expression for the line source function</p>
<div class="math notranslate nohighlight">
\[S_{ij} = \frac{n_iA_{ij}}{n_jB_{ji}-n_iB_{ij}}\]</div>
<p>leads to</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{split}
&amp; \sum_{j&gt;i} \Big[ n_jA_{ji}\beta_{ji} + (n_jB_{ji}-n_iB_{ij})\beta_{ji}J^{\mathrm{bg}}_{ji}\Big]\\
&amp; - \sum_{j&lt;i} \Big[ n_iA_{ij}\beta_{ij} + (n_iB_{ij}-n_jB_{ji})\beta_{ij}J^{\mathrm{bg}}_{ij}\Big]\\
&amp; + \sum_{j\neq i}\big[n_jC_{ji}-n_iC_{ij}\big]=0
\end{split}\end{split}\]</div>
<p>A few iteration steps are necessary, because the <span class="math notranslate nohighlight">\(\beta_{ij}\)</span> depends on the
optical depths, which depend on the populations. But since this is only a
weak dependence, the iteration should converge rapidly.</p>
<p>To use the LVG+EscProb method, the following has to be done:</p>
<ul class="simple">
<li><p>Make sure that you use a molecular data file that contains
collision rate tables (see Section <a class="reference internal" href="#sec-molecule-xxx-inp"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a>).</p></li>
<li><p>Make sure to provide file(s) containing the number densities
of the collision partners, e.g. <code class="docutils literal notranslate"><span class="pre">numberdens_p-h2.inp</span></code>
(see Section <a class="reference internal" href="#sec-collpartner"><span class="std std-ref">INPUT: The number density of collision partners (for non-LTE transfer)</span></a>).</p></li>
<li><p>Make sure to link the rate tables to the number density
files in <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code> (see Section <a class="reference internal" href="#sec-line-dot-inp"><span class="std std-ref">INPUT: The line.inp file</span></a>).</p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">lines_mode=3</span></code> in the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file.</p></li>
<li><p>You may want to also specify the maximum number of iterations for
non-LTE iterations, by setting <code class="docutils literal notranslate"><span class="pre">lines_nonlte_maxiter</span></code> in the
<code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file. The default is 100 (as of version 0.36). If
convergence is not reached within <code class="docutils literal notranslate"><span class="pre">lines_nonlte_maxiter</span></code>
iterations, RADMC-3D stops.</p></li>
<li><p>You may want to also specify the convergence criterion
for non-LTE iterations, by setting <code class="docutils literal notranslate"><span class="pre">lines_nonlte_convcrit</span></code>
in the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file. The default is 1d-2 (which is
not very strict! Smaller values may be necessary).</p></li>
<li><p>Specify the gas velocity vector field in the file <code class="docutils literal notranslate"><span class="pre">gas_velocity.inp</span></code>
(or <code class="docutils literal notranslate"><span class="pre">.binp</span></code>), see Section
<a class="reference internal" href="#sec-velo-field"><span class="std std-ref">INPUT: The velocity field</span></a>. If this file is not present, the gas velocity will
be assumed to be 0 everywhere, meaning that you have pure escape
probability.</p></li>
<li><p>Specify the ‘typical length scale’ <span class="math notranslate nohighlight">\(L\)</span> at each cell in the file
<code class="docutils literal notranslate"><span class="pre">escprob_lengthscale.inp</span></code> (or <code class="docutils literal notranslate"><span class="pre">.binp</span></code>). If
this file is not present, then the length scale is assumed to be infinite,
meaning that you are back at pure LVG. The format of this file is
identical to that of the gas density.</p></li>
</ul>
<p>Note that having no <code class="docutils literal notranslate"><span class="pre">escprob_lengthscale.inp</span></code> <em>nor</em> <code class="docutils literal notranslate"><span class="pre">gas_velocity.inp</span></code> file
in your model directory means that the photons cannot escape at all, and you
should find LTE populations (always a good test of the code).</p>
<p>Note that it is essential, when using the Large Velocity Gradient method without
specifying a length scale, that the gradients in the velocity field (given in
the file <code class="docutils literal notranslate"><span class="pre">gas_velocity.inp</span></code>, see Section <a class="reference internal" href="#sec-velo-field"><span class="std std-ref">INPUT: The velocity field</span></a>) are indeed
sufficiently large. If they are zero, then this effectively means that the
optical depth in all the lines is assumed to be infinite, which means that the
populations are LTE again. If you use LVG but <em>also</em> specify a length scale in
the <code class="docutils literal notranslate"><span class="pre">escprob_lengthscale.inp</span></code> file, then this danger of unphysically LTE
populations is avoided.</p>
<p><em>NOTE: Currently this method does not yet include radiative exchange
with the dust continuum radiation field.</em></p>
<p><em>NOTE: Currently this method does not yet include radiative pumping
by stellar radiation. Will be included soon.</em></p>
</div>
<div class="section" id="non-lte-transfer-the-optically-thin-line-assumption-method">
<span id="sec-optthinpop"></span><h2>Non-LTE Transfer: The optically thin line assumption method<a class="headerlink" href="#non-lte-transfer-the-optically-thin-line-assumption-method" title="Permalink to this headline">¶</a></h2>
<p>An even simpler non-LTE method is applicable in <em>very</em> dilute
media, in which the lines are all optically thin. This means that
a photon that is emitted by the gas will never be reabsorbed.
If this condition is satisfied, then the non-LTE level populations
can be computed even easier than in the case of LVG (Section
<a class="reference internal" href="#sec-lvg"><span class="std std-ref">Non-LTE Transfer: The Large Velocity Gradient (LVG) + Escape Probability (EscProb) method</span></a>). No iteration is then required. So to activate
this, the following has to be done:</p>
<ul class="simple">
<li><p>Make sure that you use a molecular data file that contains
collision rate tables (see Section <a class="reference internal" href="#sec-molecule-xxx-inp"><span class="std std-ref">INPUT: Molecular/atomic data: The molecule_XXX.inp file(s)</span></a>).</p></li>
<li><p>Make sure to provide file(s) containing the number densities
of the collision partners, e.g. <code class="docutils literal notranslate"><span class="pre">numberdens_p-h2.inp</span></code>
(see Section <a class="reference internal" href="#sec-collpartner"><span class="std std-ref">INPUT: The number density of collision partners (for non-LTE transfer)</span></a>).</p></li>
<li><p>Make sure to link the rate tables to the number density
files in <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code> (see Section <a class="reference internal" href="#sec-line-dot-inp"><span class="std std-ref">INPUT: The line.inp file</span></a>).</p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">lines_mode=4</span></code> in the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code>
file (see Section <a class="reference internal" href="inputoutputfiles.html#sec-radmc-inp"><span class="std std-ref">INPUT: radmc3d.inp</span></a>).</p></li>
</ul>
<p><em>NOTE: Currently this method does not yet include radiative pumping
by stellar radiation.</em></p>
<p><em>NOTE: This mode does not *make</em> a model optically thin. Only
the populations of the levels are computed under the {bf assumption}
that the lines are optically thin. If you subsequently make a spectrum
or image of your model, all absorption effects are again included.*</p>
</div>
<div class="section" id="non-lte-transfer-full-non-local-modes-future">
<span id="sec-nonlte-nonlocal"></span><h2>Non-LTE Transfer: Full non-local modes (FUTURE)<a class="headerlink" href="#non-lte-transfer-full-non-local-modes-future" title="Permalink to this headline">¶</a></h2>
<p>In the near future RADMC-3D will hopefully also feature full non-LTE transfer,
in which the level populations are coupled to the full non-local radiation
field. Methods such as <em>lambda iteration</em> and <em>accelerated lambda iteration</em>
will be implemented. For nomenclature we will call these ‘non-local non-LTE
modes’.</p>
<p>For these non-local non-LTE modes the level population calculation is done
separately from the image/spectrum ray-tracing: You will run RADMC-3D first
for computing the non-LTE populations. RADMC-3D will then write these to
file. Then you will call RADMC-3D for making images/spectra. This is very
similar to the dust transfer, in which you first call RADMC-3D for the Monte
Carlo dust temperature computation, and after that for the ray-tracing.  It
is, however, different from the <em>local non-LTE</em> modes, where the
populations are calculated automatically before any image/spectrum
ray-tracing, and the populations do not have to be written to file (only if
you want to inspect them: Section <a class="reference internal" href="#sec-nonlte-write-levelpop"><span class="std std-ref">Non-LTE Transfer: Inspecting the level populations</span></a>).</p>
<p>For now, however, RADMC-3D still does not have the non-local non-LTE
modes.</p>
</div>
<div class="section" id="non-lte-transfer-inspecting-the-level-populations">
<span id="sec-nonlte-write-levelpop"></span><h2>Non-LTE Transfer: Inspecting the level populations<a class="headerlink" href="#non-lte-transfer-inspecting-the-level-populations" title="Permalink to this headline">¶</a></h2>
<p>When doing line radiative transfer it is often useful to inspect the level
populations. For instance, you may want to inspect how far from LTE your
populations are, or just check if the results are reasonable.  There are two
ways to do this:</p>
<ol class="arabic">
<li><p>When making an image or spectrum, add the command-line option
<code class="docutils literal notranslate"><span class="pre">writepop</span></code>, which will make RADMC-3D create output files
containing the level population values. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">image</span> <span class="k">lambda</span> <span class="mi">2300</span> <span class="n">writepop</span>
</pre></div>
</div>
</li>
<li><p>Just calling <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code> with the command-line
option <code class="docutils literal notranslate"><span class="pre">calcpop</span></code>, which will ask RADMC-3D to compute the
populations and write them to file, even without making any images
or spectra. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">calcpop</span>
</pre></div>
</div>
</li>
</ol>
<p>NOTE: For (future) non-local non-LTE modes (Section <a class="reference internal" href="#sec-nonlte-nonlocal"><span class="std std-ref">Non-LTE Transfer: Full non-local modes (FUTURE)</span></a>)
these level populations will anyway be written to a file, irrespective of the
<code class="docutils literal notranslate"><span class="pre">writepop</span></code> command.</p>
<p>The resulting files will have names such as <code class="docutils literal notranslate"><span class="pre">levelpop_co.dat</span></code>
(for the CO molecule). The structure is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iformat</span>                                  <span class="o">&lt;===</span> <span class="n">Typically</span> <span class="mi">1</span> <span class="n">at</span> <span class="n">present</span>
<span class="n">nrcells</span>
<span class="n">nrlevels_subset</span>
<span class="n">level1</span>  <span class="n">level2</span> <span class="o">.....</span>                     <span class="o">&lt;===</span> <span class="n">The</span> <span class="n">level</span> <span class="n">subset</span> <span class="n">selection</span>
<span class="n">popul</span><span class="p">[</span><span class="n">level1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>  <span class="n">popul</span><span class="p">[</span><span class="n">level2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">.....</span>   <span class="o">&lt;===</span> <span class="n">Populations</span> <span class="p">(</span><span class="k">for</span> <span class="n">subset</span><span class="p">)</span> <span class="n">at</span> <span class="n">cell</span> <span class="mi">1</span>
<span class="n">popul</span><span class="p">[</span><span class="n">level1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>  <span class="n">popul</span><span class="p">[</span><span class="n">level2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">.....</span>   <span class="o">&lt;===</span> <span class="n">Populations</span> <span class="p">(</span><span class="k">for</span> <span class="n">subset</span><span class="p">)</span> <span class="n">at</span> <span class="n">cell</span> <span class="mi">2</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">popul</span><span class="p">[</span><span class="n">level1</span><span class="p">,</span><span class="n">nrcells</span><span class="p">]</span>   <span class="n">popul</span><span class="p">[</span><span class="n">level2</span><span class="p">,</span><span class="n">nrcells</span><span class="p">]</span> <span class="o">....</span>
</pre></div>
</div>
<p>The first number is the format number, which is simply for RADMC-3D to be
backward compatible in the future, in case we decide to change/improve the
file format. The nrcells is the number of cells.</p>
<p>Then follows the number of levels (written as <code class="docutils literal notranslate"><span class="pre">nrlevels_subset</span></code> above). Note
that this is <em>not necessarily</em> equal to the number of levels found in the
<code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code> file (for our CO example). It will only be equal to that if
the file has been produced by the command <code class="docutils literal notranslate"><span class="pre">radmc3d</span> <span class="pre">calcpop</span></code>. If, however, the
file was produced after making an image or spectrum (e.g. through the command
<code class="docutils literal notranslate"><span class="pre">radmc3d</span> <span class="pre">image</span> <span class="pre">lambda</span> <span class="pre">2300</span> <span class="pre">writepop</span></code>), then RADMC-3D will only write out those
levels that have been used to make the image or spectrum. See Section
<a class="reference internal" href="#sec-calcstore-levpop"><span class="std std-ref">Background information: Calculation and storage of level populations</span></a> for more information about this. It is for this
reason that the file in fact contains a list of levels that are included (the
<code class="docutils literal notranslate"><span class="pre">level1</span> <span class="pre">level</span> <span class="pre">2</span> <span class="pre">...</span></code> in the above file format example).</p>
<p>After these header lines follows the actual data. Each line contains the
populations at a spatial cell in units of <span class="math notranslate nohighlight">\(\mathrm{cm}^{-3}\)</span>.</p>
<p>This file format is a generalization of the standard format which is
described for the example of dust density in Section <a class="reference internal" href="inputoutputfiles.html#sec-dustdens"><span class="std std-ref">INPUT (required for dust transfer): dust_density.inp</span></a>.
Please read that section for more details, and also on how the format
changes if you use ‘layers’.</p>
<p>Also the unformatted style is described in Section <a class="reference internal" href="inputoutputfiles.html#sec-dustdens"><span class="std std-ref">INPUT (required for dust transfer): dust_density.inp</span></a>. We
have, however, here the extra complication that at each cell we have more
than one number. Essentially this simply means that the length of the data
per cell is larger, so that fewer cells fit into a single record.</p>
</div>
<div class="section" id="non-lte-transfer-reading-the-level-populations-from-file">
<span id="sec-nonlte-read-levelpop"></span><h2>Non-LTE Transfer: Reading the level populations from file<a class="headerlink" href="#non-lte-transfer-reading-the-level-populations-from-file" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you may want to make images and/or spectra of lines based on level
populations that you calculated using another program (or calculated using
RADMC-3D at some earlier time). You can ask RADMC-3D to read these
populations from files with the same name and same format as, for example,
<code class="docutils literal notranslate"><span class="pre">levelpop_co.dat</span></code> (for CO) as described in Section
<a class="reference internal" href="#sec-nonlte-write-levelpop"><span class="std std-ref">Non-LTE Transfer: Inspecting the level populations</span></a>. The way to do this is to add a line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lines_mode</span> <span class="o">=</span> <span class="mi">50</span>
</pre></div>
</div>
<p>to the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file.</p>
<p>You can test that it works by calculating the populations using another
<code class="docutils literal notranslate"><span class="pre">lines_mode</span></code> and calling <code class="docutils literal notranslate"><span class="pre">radmc3d</span> <span class="pre">calcpop</span> <span class="pre">writepop</span></code> (which will produce the
<code class="docutils literal notranslate"><span class="pre">levelpop_xxx.dat</span></code> file); then change <code class="docutils literal notranslate"><span class="pre">lines_mode</span></code> to 50, and call <code class="docutils literal notranslate"><span class="pre">radmc3d</span>
<span class="pre">image</span> <span class="pre">iline</span> <span class="pre">1</span></code>. You should see a message that RAMDC-3D is actually reading the
populations (and it may, for 3-D models, take a bit of time to read the large
file).</p>
<p>Because of the rather lage size of these files for 3-D models, it might be
worthwhile to make sure to reduce the number of levels of the
<code class="docutils literal notranslate"><span class="pre">molecule_xx.inp</span></code> files to only those you actually need.</p>
</div>
<div class="section" id="what-can-go-wrong-with-line-transfer">
<span id="sec-lines-pitfalls"></span><h2>What can go wrong with line transfer?<a class="headerlink" href="#what-can-go-wrong-with-line-transfer" title="Permalink to this headline">¶</a></h2>
<p>Even the simple task of performing a ray-tracing line transfer calculation
with given level populations (i.e. the so-called <em>formal transfer
equation</em>) is a non-trivial task in complex 3-D AMR models with possibly
highly supersonic motions. I recommend the user to do extensive and critical
experimentation with the code and make many simple tests to check if the
results are as they are expected to be. In the end a result must be
understandable in terms of simple argumentation. If weird effects show up,
please do some detective work until you understand why they show up, i.e.
that they are either a <em>real</em> effect or a numerical issue. There are
many numerical artifacts that can show up that are <em>not</em> a bug in the
code. The code simply does a numerical integration of the equations on some
spatial- and wavelength-grid. If the user chooses these grids unwisely, the
results may be completely wrong even if the code is formally OK. These
possible pitfalls is what this section is about.</p>
<p>So here is a list of things to check:</p>
<ol class="arabic simple">
<li><p>Make sure that the line(s) you want to model are indeed in the
molecular data file you use. Also make sure that it/they are included in
the line selection (if you are using this option; by default all lines and
levels from the molecular/atomic data files are included; see Section
<a class="reference internal" href="#sec-calcstore-levpop"><span class="std std-ref">Background information: Calculation and storage of level populations</span></a>).</p></li>
<li><p>If you do LTE line transfer, and you do not let <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code>
read in a special file for the partition function, then the partition
function will be computed internally by <code class="docutils literal notranslate"><span class="pre">radmc3d</span></code>. The code will
do so based on the levels specified in the <code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code>
file for molecule <code class="docutils literal notranslate"><span class="pre">XXX</span></code>. This requires of course that all levels
that may be excited at the temperatures found in the model are in fact
present in the <code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code> file. If, for instance, you
model 1.3 mm and 2.6 mm rotational lines of CO gas of up to 300 K, and
your file <code class="docutils literal notranslate"><span class="pre">molecule_co.inp</span></code> only contains the first three
levels because you think you only need those for your 1.3 and 2.6 mm
lines, and you <em>don’t</em> specify the partition function explicitly, then
<code class="docutils literal notranslate"><span class="pre">radmc3d</span></code> will compute the partition function for all
temperatures including 300 K based on only the first three levels. This is
evidently wrong. The nasty thing is: the resulting lines won’t be totally
absurd. They will just be too bright. But this can easily go undetected by
you as the user. So please keep this always in mind.  Note that if you
make a <em>selection</em> of the first three levels (see Section
<a class="reference internal" href="#sec-line-selection"><span class="std std-ref">For experts: Selecting a subset of lines and levels ‘manually’</span></a>) but the file <code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code>
contains many more levels, then this problem will not appear, because the
partition function will be calculated on the original data from the
<code class="docutils literal notranslate"><span class="pre">molecule_XXX.inp</span></code> file, not from the selected levels.  Of
course it is safer to specify the true partition function directly through
the file <code class="docutils literal notranslate"><span class="pre">partitionfunction_XXX.inp</span></code> (see Section
<a class="reference internal" href="#sec-partition-function"><span class="std std-ref">INPUT for LTE line transfer: The partition function (optional)</span></a>).</p></li>
<li><p>If you have a model with non-zero gas velocities, and if these gas
velocities have cell-to-cell differences that are larger than or equal to
the intrinsic (thermal+microturbulent) line width, then the ray-tracing
will not be able to pick up signals from intermediate velocities. In other
words, because of the discrete gridding of the model, only discrete
velocities are present, which can cause numerical problems. See
Fig. <a class="reference internal" href="#fig-doppler-catch"><span class="std std-numref">Fig. 8</span></a>-Left for a pictographic representation of
this problem. There are two possible solutions. One is the wavelength band
method described in Section <a class="reference internal" href="imagesspectra.html#sec-wavelength-bands"><span class="std std-ref">Heads-up: In reality wavelength are actually wavelength bands</span></a>.  But a more
systematic method is the ‘doppler catching’ method described in Section
<a class="reference internal" href="#sec-doppler-catching"><span class="std std-ref">Preventing doppler jumps: The ‘doppler catching method’</span></a> (which can be combined with the wavelength band
method of Section <a class="reference internal" href="imagesspectra.html#sec-wavelength-bands"><span class="std std-ref">Heads-up: In reality wavelength are actually wavelength bands</span></a> to make it even more
perfect).</p></li>
</ol>
</div>
<div class="section" id="preventing-doppler-jumps-the-doppler-catching-method">
<span id="sec-doppler-catching"></span><h2>Preventing doppler jumps: The ‘doppler catching method’<a class="headerlink" href="#preventing-doppler-jumps-the-doppler-catching-method" title="Permalink to this headline">¶</a></h2>
<p>If the local co-moving line width of a line (due to thermal/fundamental
broadning and/or local subgrid ‘microturbulence’) is much smaller than the
typical velocity fields in the model, then a dangerous situation can
occur. This can happen if the co-moving line width is narrower than the
doppler shift between two adjacent cells. When a ray is traced, in one cell
the line can then have a doppler shift substantially to the blue of the
wavelength-of-sight, while in the next cell the line suddenly shifted to the
red side. If the intrinsic (= thermal + microturbulent) line width is
smaller than these shifts, neither cell gives a contribution to the emission
in the ray. See Fig. <a class="reference internal" href="#fig-doppler-jump"><span class="std std-numref">Fig. 7</span></a> for a pictographic
representation of this problem. In reality the doppler shift between these
two cells would be smooth, and thus the line would smoothly pass over the
wavelength-of-sight, and thus make a contribution. Therefore the numerical
integration may thus go wrong.</p>
<div class="figure align-default" id="id1">
<span id="fig-doppler-jump"></span><a class="reference internal image-reference" href="_images/line_doppjump.png"><img alt="_images/line_doppjump.png" src="_images/line_doppjump.png" style="width: 75%;" /></a>
<p class="caption"><span class="caption-number">Fig. 7 </span><span class="caption-text">Pictographic representation of the doppler jumping problem with
ray-tracing through a model with strong cell-to-cell velocity differences.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="id2">
<span id="fig-doppler-catch"></span><a class="reference internal image-reference" href="_images/line_doppcatch.png"><img alt="_images/line_doppcatch.png" src="_images/line_doppcatch.png" style="width: 75%;" /></a>
<p class="caption"><span class="caption-number">Fig. 8 </span><span class="caption-text">Right: Pictographic representation of the doppler catching method to
prevent this problem: First of all, second order integration is done
instead of first order. Secondly, the method automatically detects a
possibly dangerous doppler jump and makes sub-steps to neatly integrate
over the line that shifts in- and out of the wavelength channel of
interest.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>The problem is described in more detail in Section <a class="reference internal" href="imagesspectra.html#sec-wavelength-bands"><span class="std std-ref">Heads-up: In reality wavelength are actually wavelength bands</span></a>,
and one possible solution is proposed there.  But that solution does not always
solve the problem.</p>
<p>RADMC-3D has a special method to catch situations like the above, and when
it detects one, to make sub-steps in the integration of the formal transfer
equation so that the smooth passing of the line through the
wavelength-of-sight can be properly accounted for. Here this is called
‘doppler catching’, for lack of a better name. The technique was discussed
in great detail in Pontoppidan et al. (2009, ApJ 704, 1482). The idea is
that the method automatically tests if a line might ‘doppler jump’ over
the current wavelength channel. If so, it will insert substeps in the
integration at the location where this danger is present. See
Fig. <a class="reference internal" href="#fig-doppler-catch"><span class="std std-numref">Fig. 8</span></a> for a pictographic representation of this
method. Note that this method can only be used with the second order
ray-tracing (see Section <a class="reference internal" href="imagesspectra.html#sec-second-order"><span class="std std-ref">Second order ray-tracing (Important information!)</span></a>); in fact, as soon as you
switch the doppler catching on, RADMC-3D will automatically also switch on
the second order ray-tracing.</p>
<p>To switch on doppler catching, you simply add the command-line option
<code class="docutils literal notranslate"><span class="pre">doppcatch</span></code> to the image or spectrum command. For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">spectrum</span> <span class="n">iline</span> <span class="mi">1</span> <span class="n">widthkms</span> <span class="mi">10</span> <span class="n">doppcatch</span>
</pre></div>
</div>
<p>(again: you do not need to add <code class="docutils literal notranslate"><span class="pre">secondorder</span></code>, because it is automatic when
<code class="docutils literal notranslate"><span class="pre">doppcatch</span></code> is used).</p>
<p>The Doppler catching method will assure that the line is integrated over with
small enough steps that it cannot accidently get jumped over. How fine these
steps will be can be adjusted with the <code class="docutils literal notranslate"><span class="pre">catch_doppler_resolution</span></code> keyword in
the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file. The default value is 0.2, meaning that it will make
the integration steps small enough that the doppler shift over each step is not
more than 0.2 times the local intrinsic (thermal+microturbulent) line
width. That is usually enough, but for some problems it might be important to
ensure that smaller steps are taken. By adding a line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">catch_doppler_resolution</span> <span class="o">=</span> <span class="mf">0.05</span>
</pre></div>
</div>
<p>to the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file you will ensure that steps are small
enough that the doppler shift is at most 0.05 times the local line width.</p>
<p>So why is doppler catching an <em>option</em>, i.e. why would this not be standard?
The reason is that doppler catching requires second order integration, which
requires RADMC-3D to first map all the cell-based quantities to the
cell-corners. This requires extra memory, which for very large models can be
problematic. It also requires more CPU time to calculate images/spectra with
second order integration. So if you do not need it, i.e. if your velocity
gradients are not very steep compared to the intrinsic line width, then it saves
time and memory to not use doppler catching.</p>
<p>It is, however, important to realize that doppler catching is not the golden
bullet. Even with doppler catching it might happen that some line flux is lost,
but this time as a result of too low <em>image resolution</em>. This is less likely to
happen in problems like ISM turbulence, but it is pretty likely to happen in
models of rotating disks. Suppose we have a very thin local line width (i.e.
low gas temperature and no microturbulence) in a rotating thin disk around a
star. In a given velocity channel (i.e. at a given observer-frame frequency) a
molecular line in the disk emits only in a very thin ‘ear-shaped’ ring or band
in the image. The thinner the intrinsic line width, the thinner the band on the
image. See Pontoppidan et al. (2009, ApJ 704, 1482) and Pavlyuchenkov et
al. (2007, ApJ 669, 1262) for example. If the pixel-resolution of the image is
smaller than that of this band, the image is simply underresolved.  This has
nothing to do with the doppler jumping problem, but can be equally devastating
for the results if the user is unaware of this. There appears to be only one
proper solution: assure that the pixel-resolution of the image is sufficiently
fine for the problem at hand. This is easy to find out: The image would simply
look terribly noisy if the resolution is insufficient. However, if you are not
interested in the images, but only in the spectra, then some amount of noisiness
in the image (i.e. marginally sufficient resolution) is OK, since the total
flux is an integral over the entire image, smearing out much of the noise.  It
requires some experimentation, though.</p>
<p>Here are some additional issues to keep in mind:</p>
<ul class="simple">
<li><p>The doppler catching method uses second order integration (see Section
<a class="reference internal" href="imagesspectra.html#sec-second-order"><span class="std std-ref">Second order ray-tracing (Important information!)</span></a>), and therefore all the relevant quantities first
have to be interpolated from the cell centers to the cell corners. Well
inside the computational domain this amounts to linear interpolation. But
at the edges of the domain it would require <em>extra</em> polation.
In 1-D this is more easily illustrated, because
there the cell corners are in fact cell interfaces. Cells <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(i+1\)</span>
share cell interface <span class="math notranslate nohighlight">\(i+1/2\)</span>. If we have <span class="math notranslate nohighlight">\(N\)</span> cells, i.e. cells
<span class="math notranslate nohighlight">\(i=1,\cdots,N\)</span>, then we have <span class="math notranslate nohighlight">\(N+1\)</span> interfaces, i.e. interfaces
<span class="math notranslate nohighlight">\(i=\tfrac{1}{2},\cdots,N+\tfrac{1}{2}\)</span>. To get physical quantities from
the cell centers to cell interfaces
<span class="math notranslate nohighlight">\(i=\tfrac{3}{2},\cdots,N-\tfrac{1}{2}\)</span> requires just interpolation. But
to find the physical quantities at cell interfaces <span class="math notranslate nohighlight">\(i=\tfrac{1}{2}\)</span> and
<span class="math notranslate nohighlight">\(i=N+\tfrac{1}{2}\)</span> one has to extrapolate or simply take the values at
the cell centers <span class="math notranslate nohighlight">\(i=1\)</span> and <span class="math notranslate nohighlight">\(i=N\)</span>. RADMC-3D does not do
extrapolation but simply takes the average values of the nearest
cells. Also the gas velocity is treated like this. This means that over
the edge cells the gradient in the gas velocity tends to be (near)
0. Since for the doppler catching it is the gradient of the velocity that
matters, this might yield some artifacts in the spectrum if the density in
the border cells is high enough to produce substantial line
emission. Avoiding this numerical artifact is relatively easy: One should
then simply put the number density of the molecule in question to zero in
the boundary cells.</p></li>
<li><p>If you are using RADMC-3D on a 3-D (M)HD model which has strong shocks
in its domain, then one must be careful that (magneto-)hydrodynamic codes
tend to smear out the shock a bit. This means that there will be some
cells that have intermediate density and velocity in the smeared out
region of the shock. This is unphysical, but an intrinsic numerical
artifact of numerical hydrodynamics codes. This might, under some
conditions, lead to unphysical signal in the spectrum, because there would
be cells at densities, temperatures and velocities that would be in
between the values at both sides of the shock and would, in reality, not
be there. It is very difficult to avoid this problem, and even to find out
if this problem is occurring and by how much. One must simply be very
careful of models containing strong shocks and do lots of testing.  One
way to test is to use the doppler catching method and vary the doppler
catching resolution (using the <code class="docutils literal notranslate"><span class="pre">catch_doppler_resolution</span></code>
keyword in <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code>).</p></li>
<li><p>If using line transfer in spherical coordinates using doppler
catching, the linear interpolation of the line shift between the beginning
and the end of a segment may not always be enough to accurately prevent
doppler jumps. This is because in addition to the physical gradient of gas
velocity, the projected gas velocity along a ray changes also along the
ray due to the geometry (the use of spherical coordinates). Example: a
spherically symmetric radially outflowing wind with constant outward
velocity <span class="math notranslate nohighlight">\(v_r=\)</span> is constant, the 3-D <em>vector</em>
<span class="math notranslate nohighlight">\(\vec v\)</span> is not constant, since it always points outward. A ray through
this wind will thus have a varying <span class="math notranslate nohighlight">\(\vec n\cdot \vec v\)</span> along the ray.  In
the cell where the ray reaches its closest approach to the origin of the
coordinate system the <span class="math notranslate nohighlight">\(\vec n\cdot \vec v\)</span> will vary the strongest.  This
may be such a strong effect that it could affect the reliability of the
code. <em>As of version 0.41 of this code a method is in place to prevent
this</em>. It is switched on by default, but it can be switched off manually
for testing purposes. See Section <a class="reference internal" href="imagesspectra.html#sec-secord-spher"><span class="std std-ref">Second order integration in spherical coordinates: a subtle issue</span></a> for details.</p></li>
</ul>
</div>
<div class="section" id="background-information-calculation-and-storage-of-level-populations">
<span id="sec-calcstore-levpop"></span><h2>Background information: Calculation and storage of level populations<a class="headerlink" href="#background-information-calculation-and-storage-of-level-populations" title="Permalink to this headline">¶</a></h2>
<p>If RADMC-3D makes an image or a spectrum with molecular (or atomic) lines
included, then the level populations of the molecules/atoms have to be
computed. In the standard method of ray-tracing of images or spectra, these
level populations are first calculated in each grid cell and stored in a global
array. Then the raytracer will render the image or spectrum.</p>
<p>The storage of the level populations is a tricky matter, because if this is done
in the obvious manner, it might require a huge amount of memory. This would then
prevent us from making large scale models. For instance: if you have a molecule
with 100 levels in a model with 256x256x256 <span class="math notranslate nohighlight">\(\simeq 1.7\times 10^7\)</span> cells,
the global storage for the populations alone (with each number in double
precision) would be roughly 100x8x256x256x256 <span class="math notranslate nohighlight">\(\simeq\)</span> 13 Gigabyte.</p>
<p>However, if you intend to make a spectrum in just 1 line, you do not need all
these level populations. To stick to the above example, let us take the CO 1-0
line, which is then line 1 and which connects levels <span class="math notranslate nohighlight">\(J=1\)</span> and
<span class="math notranslate nohighlight">\(J=0\)</span>, which are levels 2 and 1 in the code (if you use the Leiden
database CO data file).  Once the populations have been computed, we only need
to store the levels 1 and 2. This would then require 2x8x256x256x256
<span class="math notranslate nohighlight">\(\simeq\)</span> 0.26 Gigabyte, which would be <em>much</em> less memory-costly.</p>
<p>As of version 0.29 RADMC-3D automatically figures out which levels have to
be stored in a global array, in order to be able to render the images or the
spectrum properly. RADMC-3D will go through all the lines of all molecules
and checks if they contribute to the wavelength(s), of the image(s) or the
spectrum. Once it has assembled a list of ‘active’ lines, it will make a
list of ‘active’ levels that belong to these lines. It will then declare
this to be the ‘subset’ of levels for which the populations will be stored
globally.</p>
<p>In other words: RADMC-3D now takes care of the memory-saving storage of
the populations automatically.</p>
<p><em>How does RADMC-3D decide whether a line contributes to some wavelength</em>
<span class="math notranslate nohighlight">\(\lambda\)</span>? A line <span class="math notranslate nohighlight">\(i\)</span> with line center <span class="math notranslate nohighlight">\(\lambda_i\)</span> is
considered to contribute to an image at wavelength <span class="math notranslate nohighlight">\(\lambda\)</span> if</p>
<div class="math notranslate nohighlight">
\[| \lambda_i-\lambda | \le C_{\mathrm{margin}}\Delta\lambda_i\]</div>
<p>where <span class="math notranslate nohighlight">\(\Delta\lambda_i\)</span> is the line width (including all contributions)
and <span class="math notranslate nohighlight">\(C_{\mathrm{margin}}\)</span> is a constant. By default</p>
<div class="math notranslate nohighlight">
\[C_{\mathrm{margin}} = 12\]</div>
<p>But you can change this to another value, say 24, by adding in the
<code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file a line containing, e.g. <code class="docutils literal notranslate"><span class="pre">lines_widthmargin</span> <span class="pre">=</span> <span class="pre">24</span></code>.</p>
<p>You can in fact get a dump of the level populations that have been computed and
used for the image(s)/spectrum you created, by adding <code class="docutils literal notranslate"><span class="pre">writepop</span></code> on the
command line. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">radmc3d</span> <span class="n">spectrum</span> <span class="n">iline</span> <span class="mi">1</span> <span class="n">widthkms</span> <span class="mi">10</span> <span class="n">writepop</span>
</pre></div>
</div>
<p>This then creates (in addition to the spectrum) a file called (for our
example of the CO molecule) <code class="docutils literal notranslate"><span class="pre">levelpop_co.dat</span></code>. Here is how you can read
this data in Python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">radmc3d_tools</span> <span class="k">import</span> <span class="n">simpleread</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">simpleread</span><span class="o">.</span><span class="n">read_levelpop</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">data</span></code> object then contains <code class="docutils literal notranslate"><span class="pre">data.pop</span></code> and <code class="docutils literal notranslate"><span class="pre">data.relpop</span></code>, which are
the level populations in <span class="math notranslate nohighlight">\(1/cm^3\)</span> and in normalized form.</p>
<p>If, for some reason, you want always <em>all</em> levels to be stored (and you can
afford to do so with the size of your computer’s memory), you can make RADMC-3D
do so by adding <code class="docutils literal notranslate"><span class="pre">noautosubset</span></code> as a keyword to the command line, or by adding
<code class="docutils literal notranslate"><span class="pre">lines_autosubset</span> <span class="pre">=</span> <span class="pre">0</span></code> to the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file. However, for other than
code testing purposes, it seems unlikely you will wish to do this.</p>
</div>
<div class="section" id="in-case-it-is-necessary-on-the-fly-calculation-of-populations">
<span id="sec-onthefly"></span><h2>In case it is necessary: On-the-fly calculation of populations<a class="headerlink" href="#in-case-it-is-necessary-on-the-fly-calculation-of-populations" title="Permalink to this headline">¶</a></h2>
<p>There might be rare circumstances in which you do not want to have to store
the level populations in a global array. For example: you are making a spectrum
of the CO bandhead, in which case you have many tens of lines in a single
spectrum. If your model contains 256x256x256 cells (see example in Section
<a class="reference internal" href="#sec-calcstore-levpop"><span class="std std-ref">Background information: Calculation and storage of level populations</span></a>) then this might easily require many Gigabytes of
memory just to store the populations.</p>
<p>For the LTE, LVG and optically thin level population modes there is a way out:
You can force RADMC-3D to compute the populations <em>on-the-fly</em> during the
ray-tracing, which does not require a global storage of the level populations.</p>
<p>The way to do this is simple: Just make the <code class="docutils literal notranslate"><span class="pre">lines_mode</span></code> negative. So for
on-the-fly LTE mode use <code class="docutils literal notranslate"><span class="pre">lines_mode=-1</span></code>, for on-the-fly user-defined
populations mode use <code class="docutils literal notranslate"><span class="pre">lines_mode=-2</span></code>, for on-the-fly LVG mode use
<code class="docutils literal notranslate"><span class="pre">lines_mode=-3</span></code> and for on-the-fly optically thin populations use
<code class="docutils literal notranslate"><span class="pre">lines_mode=-4</span></code>.</p>
<p><em>NOTE: The drawback of this method is that, under certain circumstances, it can
slow down the code dramatically.</em> This slow-down happens if you use e.g.
second-order integration (Section <a class="reference internal" href="imagesspectra.html#sec-second-order"><span class="std std-ref">Second order ray-tracing (Important information!)</span></a>) and/or doppler
catching (Section <a class="reference internal" href="#sec-doppler-catching"><span class="std std-ref">Preventing doppler jumps: The ‘doppler catching method’</span></a>) together with non-trivial
population solving methods like LVG. So please use the on-the-fly method only
when you are forced to do so (for memory reasons).</p>
</div>
<div class="section" id="for-experts-selecting-a-subset-of-lines-and-levels-manually">
<span id="sec-line-selection"></span><h2>For experts: Selecting a subset of lines and levels ‘manually’<a class="headerlink" href="#for-experts-selecting-a-subset-of-lines-and-levels-manually" title="Permalink to this headline">¶</a></h2>
<p>As explained in Section <a class="reference internal" href="#sec-calcstore-levpop"><span class="std std-ref">Background information: Calculation and storage of level populations</span></a>, RADMC-3D automatically
makes a selection of levels for which it will allocate memory for the global
level population storage.</p>
<p>If, for some reason, you wish to make this selection yourself ‘by hand’, this
can also be done. However, please be informed that there are very few
circumstances under which you may want to do this. The automatic subset
selection of RADMC-3D is usually sufficient!</p>
<p><em>If</em> you decided to really want to do this, here is how:</p>
<ol class="arabic simple">
<li><p>Switch off the automatic subset selection by adding <code class="docutils literal notranslate"><span class="pre">noautosubset</span></code> as
a keyword to the command line, or by adding <code class="docutils literal notranslate"><span class="pre">lines_autosubset</span> <span class="pre">=</span> <span class="pre">0</span></code> to
the <code class="docutils literal notranslate"><span class="pre">radmc3d.inp</span></code> file.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">lines.inp</span></code> file, for each molecule, modify the
‘0 0’ (the first two zeroes after ‘leiden’) in the way described below.</p></li>
</ol>
<p>In Section <a class="reference internal" href="#sec-line-dot-inp"><span class="std std-ref">INPUT: The line.inp file</span></a> you can see that each molecule has a line
like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">co</span>   <span class="n">leiden</span>   <span class="mi">0</span>  <span class="mi">0</span>  <span class="mi">0</span>
</pre></div>
</div>
<p>or so (here for the example of CO). In Section <a class="reference internal" href="#sec-line-dot-inp"><span class="std std-ref">INPUT: The line.inp file</span></a> we
explained the meaning of the third number, but we did not explain the meaning of
the first and second ones. These are meant for this subset selection. If we want
to store only the first 10 levels of the CO molecule, then replace the above
line with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">co</span>   <span class="n">leiden</span>   <span class="mi">0</span>  <span class="mi">10</span>  <span class="mi">0</span>
</pre></div>
</div>
<p>If you want to select specific levels (let us choose the <code class="docutils literal notranslate"><span class="pre">ilevel=3</span></code> and
<code class="docutils literal notranslate"><span class="pre">ilevel=4</span></code> levels of the above example), then write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">co</span>   <span class="n">leiden</span>   <span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">0</span>
<span class="mi">3</span> <span class="mi">4</span>
</pre></div>
</div>
<p>The ‘1’ says that a list of levels follows, the ‘2’ says that two levels will be
selected and the next line with ‘3’ and ‘4’ say that levels 3 and 4 should be
selected.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="imagesspectra.html" class="btn btn-neutral float-right" title="Making images and spectra" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="dustradtrans.html" class="btn btn-neutral float-left" title="Dust continuum radiative transfer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Cornelis Dullemond

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>